<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµå¸³ | æœå¯¦æ¬é‹å·¥</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/frontend/css/style.css">
</head>

<body>
    <header class="header">
        <div class="header-content">
            <a href="/frontend/" class="logo">
                <span class="logo-icon">ğŸ‡</span>
                <span>æœå¯¦æ¬é‹å·¥</span>
            </a>
            <div class="header-actions">
                <a href="/frontend/cart.html" class="cart-icon">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count" style="display: none;">0</span>
                </a>
            </div>
        </div>
    </header>

    <div class="page-header">
        <div class="container">
            <h1 class="page-title"><i class="fas fa-credit-card"></i> çµå¸³</h1>
        </div>
    </div>

    <main class="container">
        <div class="checkout-container" id="checkout-container">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>Â© 2025 æœå¯¦æ¬é‹å·¥ Fruit Porter. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <script src="/frontend/js/api.js"></script>
    <script src="/frontend/js/cart.js"></script>
    <script src="/frontend/js/main.js"></script>
    <script>
        let cartItems = [];
        let cartTotal = 0;
        let userCredit = 0;

        async function loadCheckout() {
            const container = document.getElementById('checkout-container');

            if (!TokenManager.isLoggedIn()) {
                window.location.href = '/frontend/login.html';
                return;
            }

            try {
                const { items, total } = await API.cart.get();

                if (items.length === 0) {
                    window.location.href = '/frontend/cart.html';
                    return;
                }

                cartItems = items;
                cartTotal = total;

                const user = TokenManager.getUser();
                const profile = (await API.auth.getProfile()).user;
                userCredit = profile.credit || 0;

                const shipping = total >= 799 ? 0 : 100;
                const finalTotal = total + shipping;
                const hasEnoughCredit = userCredit >= finalTotal;

                container.innerHTML = `
                    <div class="checkout-form">
                        <h3><i class="fas fa-truck"></i> æ”¶ä»¶è³‡è¨Š</h3>
                        <form id="checkout-form">
                            <div class="form-group">
                                <label>æ”¶ä»¶äººå§“å *</label>
                                <input type="text" id="shipping_name" value="${profile.name || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>è¯çµ¡é›»è©± *</label>
                                <input type="tel" id="shipping_phone" value="${profile.phone || ''}" placeholder="0912-345-678" required>
                            </div>
                            <div class="form-group">
                                <label>æ”¶ä»¶åœ°å€ *</label>
                                <input type="text" id="shipping_address" value="${profile.address || ''}" placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€" required>
                            </div>
                            <div class="form-group">
                                <label>è¨‚å–®å‚™è¨»</label>
                                <textarea id="notes" rows="3" placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚è«‹å¡«å¯«"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="cart-summary">
                        <h3>è¨‚å–®æ˜ç´°</h3>
                        
                        <!-- é¡åº¦é¡¯ç¤º -->
                        <div style="margin-bottom: 20px; padding: 15px; border-radius: 12px; background: ${hasEnoughCredit ? 'rgba(45, 138, 78, 0.15)' : 'rgba(231, 76, 60, 0.15)'}; border: 1px solid ${hasEnoughCredit ? 'rgba(45, 138, 78, 0.3)' : 'rgba(231, 76, 60, 0.3)'};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-wallet" style="color: ${hasEnoughCredit ? '#2d8a4e' : '#e74c3c'};"></i>
                                    æ‚¨çš„é¡åº¦
                                </span>
                                <strong style="font-size: 1.2rem; color: ${hasEnoughCredit ? '#2d8a4e' : '#e74c3c'};">$${userCredit.toLocaleString()}</strong>
                            </div>
                            ${!hasEnoughCredit ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(231, 76, 60, 0.3);">
                                    <p style="color: #e74c3c; font-weight: 600; margin: 0;">
                                        <i class="fas fa-exclamation-triangle"></i> é¡åº¦ä¸è¶³ï¼Œè«‹è¯çµ¡ç®¡ç†äººå“¡
                                    </p>
                                    <p style="color: rgba(255,255,255,0.6); font-size: 0.85rem; margin: 5px 0 0 0;">
                                        éœ€è¦é¡åº¦: $${finalTotal.toLocaleString()}ï¼Œç›®å‰é¡åº¦: $${userCredit.toLocaleString()}
                                    </p>
                                </div>
                            ` : `
                                <p style="color: #2d8a4e; font-size: 0.85rem; margin: 5px 0 0 0;">
                                    âœ“ é¡åº¦å……è¶³ï¼Œå¯ä»¥çµå¸³
                                </p>
                            `}
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            ${items.map(item => `
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <span style="flex: 1;">${item.name} x ${item.quantity}</span>
                                    <span>${formatPrice(item.price * item.quantity)}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="summary-row">
                            <span>å•†å“å°è¨ˆ</span>
                            <span>${formatPrice(total)}</span>
                        </div>
                        <div class="summary-row">
                            <span>é‹è²»</span>
                            <span>${shipping === 0 ? 'å…é‹è²»' : formatPrice(shipping)}</span>
                        </div>
                        <div class="summary-row total">
                            <span>ç¸½é‡‘é¡</span>
                            <span>${formatPrice(finalTotal)}</span>
                        </div>
                        ${hasEnoughCredit ? `
                            <button type="submit" class="btn btn-primary" onclick="submitOrder()">
                                <i class="fas fa-check"></i> ç¢ºèªä¸‹å–®
                            </button>
                        ` : `
                            <button type="button" class="btn" style="background: #666; cursor: not-allowed;" disabled>
                                <i class="fas fa-ban"></i> é¡åº¦ä¸è¶³ï¼Œç„¡æ³•ä¸‹å–®
                            </button>
                        `}
                        <a href="/frontend/cart.html" class="btn btn-outline" style="margin-top: 10px;">
                            <i class="fas fa-arrow-left"></i> è¿”å›è³¼ç‰©è»Š
                        </a>
                    </div>
                `;
            } catch (error) {
                console.error('è¼‰å…¥çµå¸³é å¤±æ•—:', error);
                container.innerHTML = '<p style="color: #e74c3c; text-align: center;">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</p>';
            }
        }

        async function submitOrder() {
            const shipping_name = document.getElementById('shipping_name').value.trim();
            const shipping_phone = document.getElementById('shipping_phone').value.trim();
            const shipping_address = document.getElementById('shipping_address').value.trim();
            const notes = document.getElementById('notes').value.trim();

            if (!shipping_name || !shipping_phone || !shipping_address) {
                showToast('è«‹å¡«å¯«å®Œæ•´çš„æ”¶ä»¶è³‡è¨Š', 'error');
                return;
            }

            // é‡æ–°æª¢æŸ¥é¡åº¦
            try {
                const profile = (await API.auth.getProfile()).user;
                const { total } = await API.cart.get();
                const shipping = total >= 799 ? 0 : 100;
                const finalTotal = total + shipping;

                if ((profile.credit || 0) < finalTotal) {
                    showToast('é¡åº¦ä¸è¶³ï¼Œè«‹è¯çµ¡ç®¡ç†äººå“¡', 'error');
                    return;
                }
            } catch (error) {
                showToast('é©—è­‰é¡åº¦å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                return;
            }

            try {
                const result = await API.orders.create({
                    shipping_name,
                    shipping_phone,
                    shipping_address,
                    notes
                });

                showToast('è¨‚å–®å»ºç«‹æˆåŠŸï¼', 'success');

                // è·³è½‰åˆ°è¨‚å–®é é¢
                setTimeout(() => {
                    window.location.href = '/frontend/orders.html';
                }, 1500);
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', loadCheckout);
    </script>
</body>

</html>