<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„è¨‚å–® | æœå¯¦æ¬é‹å·¥</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/frontend/css/style.css">
    <link rel="stylesheet" href="/frontend/css/themes.css">
    <script src="/frontend/js/theme.js"></script>
</head>

<body>
    <header class="header">
        <div class="header-content">
            <a href="/frontend/" class="logo">
                <span class="logo-icon">ğŸ‡</span>
                <span>æœå¯¦æ¬é‹å·¥</span>
            </a>
            <div class="header-actions">
                <a href="/frontend/cart.html" class="cart-icon">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count" style="display: none;">0</span>
                </a>
                <button class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>ç™»å‡º</span>
                </button>
            </div>
        </div>
        <nav class="nav">
            <div class="nav-content">
                <a href="/frontend/">é¦–é </a>
                <a href="/frontend/products.html">å…¨éƒ¨å•†å“</a>
                <a href="/frontend/orders.html" class="active">æˆ‘çš„è¨‚å–®</a>
            </div>
        </nav>
    </header>

    <div class="page-header">
        <div class="container" style="display:flex; justify-content:space-between; align-items:center;">
            <h1 class="page-title"><i class="fas fa-box"></i> æˆ‘çš„è¨‚å–®</h1>
            <button onclick="clearAllOrders()" class="btn"
                style="background:rgba(155,89,182,0.2); border:1px solid rgba(155,89,182,0.5); color:#9b59b6; padding:10px 20px; border-radius:8px; cursor:pointer;">
                <i class="fas fa-trash-alt"></i> æ¸…é™¤å·²å®Œæˆè¨‚å–®
            </button>
        </div>
    </div>

    <main class="container">
        <div class="orders-list" id="orders-list">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>Â© 2025 æœå¯¦æ¬é‹å·¥ Fruit Porter. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <script src="/frontend/js/api.js"></script>
    <script src="/frontend/js/cart.js"></script>
    <script src="/frontend/js/main.js"></script>

    <!-- å–æ¶ˆè¨‚å–®ç¢ºèªå½ˆçª— -->
    <div id="cancel-modal"
        style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
        <div
            style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 30px; border-radius: 16px; max-width: 450px; width: 90%; border: 1px solid rgba(255,255,255,0.1);">
            <h3 style="margin: 0 0 20px 0; color: #fff; font-size: 1.3rem;">
                <i class="fas fa-exclamation-triangle" style="color: #f39c12;"></i> å–æ¶ˆè¨‚å–®
            </h3>
            <p style="color: rgba(255,255,255,0.7); margin-bottom: 15px;">è¨‚å–®ç·¨è™Ÿï¼š<span id="cancel-order-number"></span>
            </p>
            <div style="margin-bottom: 20px;">
                <label style="color: rgba(255,255,255,0.8); display: block; margin-bottom: 8px;">è«‹å¡«å¯«å–æ¶ˆåŸå› ï¼š</label>
                <select id="cancel-reason-select"
                    style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f0f1e; color:#fff; margin-bottom:10px;">
                    <option value="">-- è«‹é¸æ“‡åŸå›  --</option>
                    <option value="è¨‚è³¼éŒ¯èª¤">è¨‚è³¼éŒ¯èª¤</option>
                    <option value="é‡è¤‡è¨‚è³¼">é‡è¤‡è¨‚è³¼</option>
                    <option value="ä¸æƒ³è¦äº†">ä¸æƒ³è¦äº†</option>
                    <option value="æƒ³æ›´æ”¹è¨‚è³¼å…§å®¹">æƒ³æ›´æ”¹è¨‚è³¼å…§å®¹</option>
                    <option value="æ‰¾åˆ°æ›´ä¾¿å®œçš„">æ‰¾åˆ°æ›´ä¾¿å®œçš„</option>
                    <option value="other">å…¶ä»–åŸå› </option>
                </select>
                <textarea id="cancel-reason-text" placeholder="è«‹èªªæ˜å…¶ä»–åŸå› ..."
                    style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:#0f0f1e; color:#fff; min-height:80px; display:none; resize:vertical;"></textarea>
            </div>
            <p style="color: #e74c3c; font-size: 0.9rem; margin-bottom: 20px;">
                <i class="fas fa-info-circle"></i> å–æ¶ˆå¾Œå°‡é€€é‚„æœƒå“¡é¡åº¦
            </p>
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button id="cancel-modal-close"
                    style="padding: 10px 20px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); background: transparent; color: #fff; cursor: pointer;">è¿”å›</button>
                <button id="cancel-confirm-btn"
                    style="padding: 10px 20px; border-radius: 8px; border: none; background: #e74c3c; color: #fff; cursor: pointer; font-weight: 600;">ç¢ºèªå–æ¶ˆè¨‚å–®</button>
            </div>
        </div>
    </div>

    <script>
        let currentCancelOrderId = null;

        // é¡¯ç¤º/éš±è—å…¶ä»–åŸå› æ–‡å­—æ¡†
        document.getElementById('cancel-reason-select').addEventListener('change', function () {
            const textArea = document.getElementById('cancel-reason-text');
            textArea.style.display = this.value === 'other' ? 'block' : 'none';
        });

        // é—œé–‰å½ˆçª—
        document.getElementById('cancel-modal-close').addEventListener('click', function () {
            document.getElementById('cancel-modal').style.display = 'none';
            currentCancelOrderId = null;
        });

        // ç¢ºèªå–æ¶ˆè¨‚å–®
        document.getElementById('cancel-confirm-btn').addEventListener('click', async function () {
            const selectValue = document.getElementById('cancel-reason-select').value;
            const textValue = document.getElementById('cancel-reason-text').value;

            let reason = selectValue === 'other' ? textValue : selectValue;

            if (!reason || reason.trim() === '') {
                alert('è«‹é¸æ“‡æˆ–å¡«å¯«å–æ¶ˆåŸå› ');
                return;
            }

            try {
                await API.orders.cancel(currentCancelOrderId, reason);
                alert('è¨‚å–®å·²å–æ¶ˆï¼Œé¡åº¦å·²é€€é‚„');
                document.getElementById('cancel-modal').style.display = 'none';
                loadOrders(); // é‡æ–°è¼‰å…¥è¨‚å–®
            } catch (error) {
                alert('å–æ¶ˆå¤±æ•—ï¼š' + error.message);
            }
        });

        function showCancelModal(orderId, orderNumber) {
            currentCancelOrderId = orderId;
            document.getElementById('cancel-order-number').textContent = orderNumber;
            document.getElementById('cancel-reason-select').value = '';
            document.getElementById('cancel-reason-text').value = '';
            document.getElementById('cancel-reason-text').style.display = 'none';
            document.getElementById('cancel-modal').style.display = 'flex';
        }

        async function loadOrders() {
            const container = document.getElementById('orders-list');

            if (!TokenManager.isLoggedIn()) {
                window.location.href = '/frontend/login.html';
                return;
            }

            try {
                const { orders } = await API.orders.getAll();

                if (orders.length === 0) {
                    container.innerHTML = `
                        <div class="cart-empty">
                            <i class="fas fa-box-open"></i>
                            <h3>é‚„æ²’æœ‰è¨‚å–®</h3>
                            <p>å¿«å»é¸è³¼å–œæ­¡çš„æ°´æœå§ï¼</p>
                            <a href="/frontend/products.html" class="btn btn-primary">
                                <i class="fas fa-shopping-bag"></i> é–‹å§‹è³¼ç‰©
                            </a>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = await Promise.all(orders.map(async order => {
                    const { items } = await API.orders.getById(order.id);

                    // å–æ¶ˆæŒ‰éˆ• (åƒ…å¾…è™•ç†ç‹€æ…‹å¯å–æ¶ˆ)
                    const cancelBtn = order.status === 'pending' ? `
                        <button onclick="showCancelModal(${order.id}, '${order.order_number}')" 
                                class="btn" style="background:#e74c3c; color:#fff; padding:8px 16px; border-radius:8px; font-size:0.85rem; cursor:pointer; margin-top:10px;">
                            <i class="fas fa-times"></i> å–æ¶ˆè¨‚å–®
                        </button>
                    ` : '';

                    // åˆªé™¤æŒ‰éˆ• (åƒ…å·²å®Œæˆæˆ–å·²å–æ¶ˆçš„è¨‚å–®å¯åˆªé™¤)
                    const deleteBtn = ['completed', 'cancelled', 'delivered'].includes(order.status) ? `
                        <button onclick="deleteOrder(${order.id}, '${order.order_number}')" 
                                class="btn" style="background:rgba(155,89,182,0.2); border:1px solid rgba(155,89,182,0.5); color:#9b59b6; padding:8px 16px; border-radius:8px; font-size:0.85rem; cursor:pointer; margin-top:10px; margin-left:10px;">
                            <i class="fas fa-trash-alt"></i> åˆªé™¤è¨˜éŒ„
                        </button>
                    ` : '';

                    // å–æ¶ˆåŸå› é¡¯ç¤º
                    const cancelReasonHtml = order.cancel_reason ? `
                        <div style="background:rgba(231,76,60,0.1); border:1px solid rgba(231,76,60,0.3); border-radius:8px; padding:10px 15px; margin-top:10px;">
                            <span style="color:#e74c3c; font-weight:600;"><i class="fas fa-info-circle"></i> å–æ¶ˆåŸå› ï¼š</span>
                            <span style="color:rgba(255,255,255,0.8);">${order.cancel_reason}</span>
                        </div>
                    ` : '';

                    // å¾Œå°å‚™è¨»é¡¯ç¤º
                    const adminNoteHtml = order.admin_note ? `
                        <div style="background:rgba(52,152,219,0.1); border:1px solid rgba(52,152,219,0.3); border-radius:8px; padding:10px 15px; margin-top:10px;">
                            <span style="color:#3498db; font-weight:600;"><i class="fas fa-comment"></i> å®¢æœå‚™è¨»ï¼š</span>
                            <span style="color:rgba(255,255,255,0.8);">${order.admin_note}</span>
                        </div>
                    ` : '';

                    return `
                        <div class="order-card">
                            <div class="order-header">
                                <div>
                                    <span class="order-number">è¨‚å–®ç·¨è™Ÿï¼š${order.order_number}</span>
                                    <span style="color: rgba(255,255,255,0.6); margin-left: 20px; font-size: 0.9rem;">
                                        ${formatDate(order.created_at)}
                                    </span>
                                </div>
                                <span class="order-status status-${order.status}">${getStatusText(order.status)}</span>
                            </div>
                            <div class="order-body">
                                <div class="order-items">
                                    ${items.map(item => `
                                        <div class="order-item">
                                            <div class="order-item-image">
                                                ${item.image_url
                            ? `<img src="${item.image_url}" alt="${item.name}" onerror="this.parentElement.innerHTML='ğŸ'">`
                            : '<div style="display:flex;align-items:center;justify-content:center;height:100%;font-size:1.5rem;">ğŸ</div>'
                        }
                                            </div>
                                            <div class="order-item-info">
                                                <h4>${item.name}</h4>
                                                <p>${formatPrice(item.unit_price)} x ${item.quantity}</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                ${cancelReasonHtml}
                                ${adminNoteHtml}
                                <div class="order-footer">
                                    <div>
                                        <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">
                                            æ”¶ä»¶äººï¼š${order.shipping_name} | ${order.shipping_phone}
                                        </div>
                                        <div style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">
                                            åœ°å€ï¼š${order.shipping_address}
                                        </div>
                                        ${cancelBtn}
                                        ${deleteBtn}
                                    </div>
                                    <div class="order-total">
                                        ç¸½é‡‘é¡ï¼š<span>${formatPrice(order.total_amount)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                })).then(cards => cards.join(''));
            } catch (error) {
                console.error('è¼‰å…¥è¨‚å–®å¤±æ•—:', error);
                container.innerHTML = '<p style="color: #e74c3c; text-align: center;">è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</p>';
            }
        }

        // åˆªé™¤å–®ç­†è¨‚å–®
        async function deleteOrder(orderId, orderNumber) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤è¨‚å–® ${orderNumber} çš„è¨˜éŒ„å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) return;

            try {
                await API.orders.delete(orderId);
                alert('è¨‚å–®è¨˜éŒ„å·²åˆªé™¤');
                loadOrders();
            } catch (error) {
                alert('åˆªé™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        // æ¸…é™¤æ‰€æœ‰å·²å®Œæˆ/å·²å–æ¶ˆè¨‚å–®
        async function clearAllOrders() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å·²å®Œæˆå’Œå·²å–æ¶ˆçš„è¨‚å–®è¨˜éŒ„å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) return;

            try {
                const result = await API.orders.clearAll();
                alert(result.message);
                loadOrders();
            } catch (error) {
                alert('æ¸…é™¤å¤±æ•—ï¼š' + error.message);
            }
        }

        document.addEventListener('DOMContentLoaded', loadOrders);
    </script>
    <link rel="stylesheet" href="/frontend/css/cart-sidebar.css">
    <script src="/frontend/js/cart-sidebar.js"></script>
</body>

</html>