<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“è©³æƒ… | æœå¯¦æ¬é‹å·¥</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* ç”¢å“è©³æƒ…é æ¨£å¼ */
        .product-detail {
            margin-top: 130px;
            padding: 50px 0;
        }

        .product-detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
            align-items: start;
        }

        /* åœ–ç‰‡å€ */
        .product-gallery {
            position: sticky;
            top: 150px;
        }

        .main-image {
            width: 100%;
            height: 500px;
            border-radius: 20px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 20px;
        }

        .main-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thumbnail-list {
            display: flex;
            gap: 15px;
        }

        .thumbnail {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

        .thumbnail.active,
        .thumbnail:hover {
            border-color: var(--primary-color);
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* è³‡è¨Šå€ */
        .product-info-detail {
            padding: 0;
        }

        .product-badges-detail {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .badge-detail {
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-hot {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: #fff;
        }

        .badge-seasonal {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: #fff;
        }

        .product-title {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 15px;
            line-height: 1.3;
        }

        .product-origin-detail {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            color: rgba(255, 255, 255, 0.7);
        }

        .product-origin-detail span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .product-origin-detail i {
            color: var(--primary-light);
        }

        .product-price-detail {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
        }

        .price-current {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--accent-orange);
        }

        .price-original {
            font-size: 1.3rem;
            color: rgba(255, 255, 255, 0.4);
            text-decoration: line-through;
        }

        .price-save {
            background: #e74c3c;
            color: #fff;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .product-description {
            margin-bottom: 30px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.8;
            font-size: 1rem;
        }

        /* è¦æ ¼é¸æ“‡ */
        .product-options {
            margin-bottom: 30px;
        }

        .option-group {
            margin-bottom: 20px;
        }

        .option-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .option-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .option-btn {
            padding: 12px 24px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option-btn:hover,
        .option-btn.active {
            border-color: var(--primary-color);
            background: rgba(45, 138, 78, 0.2);
        }

        /* æ•¸é‡é¸æ“‡ */
        .quantity-section {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .quantity-label {
            font-weight: 600;
        }

        .quantity-control-detail {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
        }

        .quantity-control-detail button {
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            color: #fff;
            transition: background 0.3s;
        }

        .quantity-control-detail button:hover {
            background: var(--primary-color);
        }

        .quantity-control-detail input {
            width: 80px;
            height: 50px;
            text-align: center;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .stock-info {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
        }

        .stock-info.low {
            color: #e74c3c;
        }

        /* æ“ä½œæŒ‰éˆ• */
        .product-actions-detail {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .product-actions-detail .btn {
            flex: 1;
            padding: 18px;
            font-size: 1.1rem;
            border-radius: 14px;
        }

        .btn-add-cart {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: #fff;
        }

        .btn-add-cart:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(45, 138, 78, 0.4);
        }

        .btn-buy-now {
            background: linear-gradient(135deg, #ff6b35 0%, #f4a261 100%);
            color: #fff;
        }

        .btn-buy-now:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.4);
        }

        .btn-wishlist {
            width: 60px;
            flex: none;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .btn-wishlist:hover {
            border-color: #e74c3c;
            color: #e74c3c;
        }

        /* æœå‹™ä¿éšœ */
        .product-services {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .service-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .service-item i {
            font-size: 1.3rem;
            color: var(--primary-light);
        }

        .service-item span {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        /* ç”¢å“è©³æƒ… Tabs */
        .product-tabs {
            margin-top: 60px;
        }

        .tabs-header {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .tab-btn {
            padding: 15px 30px;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.6);
            position: relative;
            transition: all 0.3s;
        }

        .tab-btn.active,
        .tab-btn:hover {
            color: #fff;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-color);
            border-radius: 3px 3px 0 0;
        }

        .tab-content {
            display: none;
            padding: 20px 0;
        }

        .tab-content.active {
            display: block;
        }

        .tab-content h3 {
            font-size: 1.3rem;
            margin-bottom: 20px;
        }

        .tab-content p,
        .tab-content li {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.8;
            margin-bottom: 10px;
        }

        .tab-content ul {
            list-style: none;
            padding-left: 0;
        }

        .tab-content ul li::before {
            content: 'âœ“';
            color: var(--primary-light);
            margin-right: 10px;
        }

        /* ç›¸é—œç”¢å“ */
        .related-products {
            margin-top: 80px;
        }

        .related-products h2 {
            font-size: 1.8rem;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .related-products h2 i {
            color: var(--accent-orange);
        }

        /* RWD */
        @media (max-width: 1024px) {
            .product-detail-grid {
                grid-template-columns: 1fr;
                gap: 40px;
            }

            .product-gallery {
                position: static;
            }

            .main-image {
                height: 400px;
            }
        }

        @media (max-width: 768px) {
            .product-detail {
                margin-top: 110px;
                padding: 30px 0;
            }

            .main-image {
                height: 300px;
            }

            .product-title {
                font-size: 1.6rem;
            }

            .price-current {
                font-size: 2rem;
            }

            .product-actions-detail {
                flex-wrap: wrap;
            }

            .product-actions-detail .btn {
                flex: 1 1 45%;
            }

            .product-services {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">
                <span class="logo-icon">ğŸ‡</span>
                <span>æœå¯¦æ¬é‹å·¥</span>
            </a>
            <div class="search-box">
                <input type="text" placeholder="æœå°‹å•†å“...">
                <button type="submit"><i class="fas fa-search"></i></button>
            </div>
            <div class="header-actions">
                <a href="cart.html" class="cart-icon">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count" style="display: none;">0</span>
                </a>
                <a href="login.html" class="login-link">
                    <i class="fas fa-user"></i>
                    <span>ç™»å…¥</span>
                </a>
                <a href="orders.html" class="user-link" style="display: none;">
                    <i class="fas fa-user-check"></i>
                    <span class="user-name">æœƒå“¡</span>
                </a>
                <button class="logout-btn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
        <nav class="nav">
            <div class="nav-content">
                <a href="index.html">ğŸ  é¦–é </a>
                <a href="products.html">ğŸ›’ å…¨éƒ¨å•†å“</a>
                <a href="products.html?category=1">ğŸ æ˜¥ç¯€ç¦®ç›’</a>
                <a href="products.html?category=2">âœ¨ å­£ç¯€é™å®š</a>
                <a href="products.html?category=3">ğŸŒ é€²å£æ°´æœ</a>
                <a href="products.html?category=4">ğŸ‡¯ğŸ‡µ æ—¥æœ¬åš´é¸</a>
                <a href="products.html?category=5">ğŸ‡¹ğŸ‡¼ å°ç£åœ¨åœ°</a>
                <a href="products.html?category=6">ğŸ’° å„ªæƒ å°ˆå€</a>
            </div>
        </nav>
    </header>

    <main class="container">
        <section class="product-detail">
            <div class="product-detail-grid">
                <!-- åœ–ç‰‡å€ -->
                <div class="product-gallery">
                    <div class="main-image">
                        <img id="main-product-image" src="images/hero_banner_fruits_1769721071654.png" alt="å•†å“åœ–ç‰‡">
                    </div>
                    <div class="thumbnail-list">
                        <div class="thumbnail active">
                            <img src="images/hero_banner_fruits_1769721071654.png" alt="ç¸®åœ–1">
                        </div>
                        <div class="thumbnail">
                            <img src="images/gift_box_premium_1769721412356.png" alt="ç¸®åœ–2">
                        </div>
                        <div class="thumbnail">
                            <img src="images/strawberry_seasonal_1769721085772.png" alt="ç¸®åœ–3">
                        </div>
                    </div>
                </div>

                <!-- è³‡è¨Šå€ -->
                <div class="product-info-detail">
                    <div class="product-badges-detail" id="product-badges">
                        <!-- å‹•æ…‹è¼‰å…¥ -->
                    </div>

                    <h1 class="product-title" id="product-title">è¼‰å…¥ä¸­...</h1>

                    <div class="product-origin-detail" id="product-origin">
                        <span><i class="fas fa-tag"></i> <span id="product-category">-</span></span>
                        <span><i class="fas fa-box"></i> åº«å­˜: <span id="product-stock">-</span></span>
                    </div>

                    <div class="product-price-detail">
                        <span class="price-current" id="product-price">$0</span>
                        <span class="price-original" id="product-original-price" style="display: none;">$0</span>
                        <span class="price-save" id="product-discount" style="display: none;">çœ $0</span>
                    </div>

                    <div class="product-description" id="product-description">
                        <!-- å‹•æ…‹è¼‰å…¥ -->
                    </div>

                    <div class="quantity-section">
                        <span class="quantity-label">è³¼è²·æ•¸é‡</span>
                        <div class="quantity-control-detail">
                            <button onclick="changeQuantity(-1)"><i class="fas fa-minus"></i></button>
                            <input type="number" id="quantity" value="1" min="1" max="99">
                            <button onclick="changeQuantity(1)"><i class="fas fa-plus"></i></button>
                        </div>
                        <span class="stock-info" id="stock-info">åº«å­˜å……è¶³</span>
                    </div>

                    <!-- å°è¨ˆè³‡è¨Š -->
                    <div
                        style="padding: 15px; background: rgba(244, 162, 97, 0.1); border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(244, 162, 97, 0.2);">
                        <span id="subtotal-info" style="font-size: 1.1rem;">å°è¨ˆï¼š<strong
                                style="color: var(--accent-orange);">$0</strong></span>
                    </div>

                    <div class="product-actions-detail">
                        <button class="btn btn-add-cart" onclick="addToCartWithQuantity()">
                            <i class="fas fa-cart-plus"></i> åŠ å…¥è³¼ç‰©è»Š
                        </button>
                        <button class="btn btn-buy-now" onclick="buyNow()">
                            <i class="fas fa-bolt"></i> ç«‹å³è³¼è²·
                        </button>
                        <button class="btn btn-wishlist" id="wishlist-btn" onclick="toggleWishlist()">
                            <i class="far fa-heart" id="wishlist-icon"></i>
                        </button>
                    </div>

                    <div class="product-services">
                        <div class="service-item">
                            <i class="fas fa-truck"></i>
                            <span>æ»¿ $1,500 å…é‹è²»</span>
                        </div>
                        <div class="service-item">
                            <i class="fas fa-shield-check"></i>
                            <span>å“è³ªä¿è­‰</span>
                        </div>
                        <div class="service-item">
                            <i class="fas fa-sync-alt"></i>
                            <span>7å¤©é‘‘è³æœŸ</span>
                        </div>
                        <div class="service-item">
                            <i class="fas fa-headset"></i>
                            <span>å°ˆæ¥­å®¢æœ</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç”¢å“è©³æƒ… Tabs -->
            <div class="product-tabs">
                <div class="tabs-header">
                    <button class="tab-btn active" onclick="showTab('desc')">å•†å“æè¿°</button>
                    <button class="tab-btn" onclick="showTab('spec')">å•†å“è¦æ ¼</button>
                    <button class="tab-btn" onclick="showTab('shipping')">é…é€èªªæ˜</button>
                </div>

                <div class="tab-content active" id="tab-desc">
                    <h3>ğŸ å•†å“æè¿°</h3>
                    <p id="full-description">è¼‰å…¥ä¸­...</p>
                </div>

                <div class="tab-content" id="tab-spec">
                    <h3>ğŸ“‹ å•†å“è¦æ ¼</h3>
                    <ul>
                        <li>ç”¢åœ°ï¼šä¾å•†å“æ¨™ç¤º</li>
                        <li>ä¿å­˜æ–¹å¼ï¼šå†·è—ä¿é®®</li>
                        <li>ä¿å­˜æœŸé™ï¼šå»ºè­°æ”¶åˆ°å¾Œç›¡å¿«é£Ÿç”¨</li>
                        <li>åŒ…è£ï¼šé«˜ç´šç¦®ç›’ / æ¨™æº–åŒ…è£</li>
                    </ul>
                </div>

                <div class="tab-content" id="tab-shipping">
                    <h3>ğŸšš é…é€èªªæ˜</h3>
                    <ul>
                        <li>å—é«˜é›„åœ°å€ç•¶æ—¥è¨‚è³¼ã€ç•¶æ—¥é€é”ï¼ˆé™12:00å‰è¨‚è³¼ï¼‰</li>
                        <li>å…¶ä»–åœ°å€ç´„ 1-3 å€‹å·¥ä½œå¤©åˆ°è²¨</li>
                        <li>å…¨å°æ»¿ $1,500 å…é‹è²»</li>
                        <li>ä½æº«å®…é…ï¼Œç¢ºä¿é®®åº¦</li>
                        <li>å¯æŒ‡å®šé…é€æ—¥æœŸèˆ‡æ™‚æ®µ</li>
                    </ul>
                </div>
            </div>

            <!-- ç›¸é—œç”¢å“ -->
            <div class="related-products">
                <h2><i class="fas fa-heart"></i> ä½ å¯èƒ½ä¹Ÿå–œæ­¡</h2>
                <div class="products-grid" id="related-products">
                    <!-- å‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2024 æœå¯¦æ¬é‹å·¥ Fruit Porter. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="js/api.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/main.js"></script>
    <script>
        // ç”¢å“åœ–ç‰‡å°ç…§è¡¨ - æ ¹æ“šç”¢å“åç¨±å‹•æ…‹åŒ¹é…
        const productImages = {
            // ç¦®ç›’é¡
            1: 'images/gift_box_newyear_1769844937612.png',        // æ–°å¹´è±ªè¯ç¦®ç›’
            2: 'images/gift_box_classic_1769844951179.png',        // ç¶“å…¸æ°´æœç¦®ç›’
            // æ—¥æœ¬è‰è“
            3: 'images/strawberry_hakata_1769844965546.png',       // åšå¤šç”˜ç‹è‰è“
            // è˜‹æœ
            4: 'images/apple_aomori_1769845034559.png',            // é’æ£®èœœè˜‹æœ
            // æ«»æ¡ƒ
            5: 'images/cherry_jumbo_1769845006620.png',            // æ™ºåˆ©å·¨ç„¡éœ¸æ«»æ¡ƒ
            // éºé¦™è‘¡è„
            6: 'images/grape_muscat_1769845047647.png',            // æ—¥æœ¬éºé¦™è‘¡è„
            // èŒ‚è°·æŸ‘
            7: 'images/tangerine_maogu_1769844979524.png',         // å°ç£èŒ‚è°·æŸ‘
            // ç¶ è‘¡è„
            8: 'images/grape_green_1769845019750.png',             // ç¶ è‘¡è„
            // èŠ’æœ
            9: 'images/mango_aiwen_1769845089844.png',             // æ„›æ–‡èŠ’æœ
            // é³³æ¢¨
            10: 'images/pineapple_dashu_1769845077278.png',        // å¤§æ¨¹é³³æ¢¨
            // ç¶œåˆç¦®ç›’
            11: 'images/fruit_mix_box_1769845101821.png',          // ç¶œåˆæ°´æœç¦®ç›’
            // é¦™è•‰
            12: 'images/banana_taiwan_1769845115102.png',          // å°ç£é¦™è•‰
        };

        // å‹•æ…‹åŒ¹é…åœ–ç‰‡å‡½æ•¸
        function getProductImageByName(product) {
            const name = product.name.toLowerCase();
            // æŒ‰é—œéµè©åŒ¹é…
            if (name.includes('æ¦´æ§¤') || name.includes('æ¦´è“®')) return 'images/durian_premium_1769845199680.png';
            if (name.includes('ç«é¾æœ')) return 'images/dragonfruit_red_1769845145180.png';
            if (name.includes('æ°´èœœæ¡ƒ') || name.includes('ç™½æ¡ƒ')) return 'images/peach_japan_1769845159395.png';
            if (name.includes('å¥‡ç•°æœ') || name.includes('é»ƒé‡‘')) return 'images/kiwi_gold_1769845173011.png';
            if (name.includes('æœ¨ç“œ')) return 'images/papaya_taiwan_1769845185740.png';
            if (name.includes('è‰è“')) return 'images/strawberry_hakata_1769844965546.png';
            if (name.includes('æ«»æ¡ƒ')) return 'images/cherry_jumbo_1769845006620.png';
            if (name.includes('è‘¡è„') || name.includes('éºé¦™')) return 'images/grape_muscat_1769845047647.png';
            if (name.includes('è˜‹æœ')) return 'images/apple_aomori_1769845034559.png';
            if (name.includes('æ–°å¹´') || name.includes('ç¦®ç›’')) return 'images/gift_box_newyear_1769844937612.png';
            if (name.includes('ç¶“å…¸')) return 'images/gift_box_classic_1769844951179.png';
            if (name.includes('é³³æ¢¨')) return 'images/pineapple_dashu_1769845077278.png';
            if (name.includes('èŒ‚è°·') || name.includes('æŸ‘')) return 'images/tangerine_maogu_1769844979524.png';
            if (name.includes('èŠ’æœ')) return 'images/mango_aiwen_1769845089844.png';
            if (name.includes('ç¶œåˆ') || name.includes('æ°´æœç›’')) return 'images/fruit_mix_box_1769845101821.png';
            if (name.includes('é¦™è•‰')) return 'images/banana_taiwan_1769845115102.png';
            if (name.includes('ç¶ è‘¡è„') || name.includes('ç„¡ç±½')) return 'images/grape_green_1769845019750.png';
            // ä½¿ç”¨IDæ˜ å°„
            if (productImages[product.id]) return productImages[product.id];
            // é è¨­
            return 'images/hero_banner_fruits_1769721071654.png';
        }

        let currentProduct = null;

        // å–å¾—ç”¢å“ ID
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        // è¼‰å…¥ç”¢å“
        async function loadProduct() {
            if (!productId) {
                window.location.href = 'products.html';
                return;
            }

            try {
                const data = await API.products.getById(productId);
                currentProduct = data.product;
                renderProduct(currentProduct);
                loadRelatedProducts();
            } catch (error) {
                console.error('è¼‰å…¥ç”¢å“å¤±æ•—:', error);
                showToast('å•†å“ä¸å­˜åœ¨', 'error');
            }
        }

        function renderProduct(product) {
            document.title = `${product.name} | æœå¯¦æ¬é‹å·¥`;

            // åœ–ç‰‡ - ä½¿ç”¨å‹•æ…‹åŒ¹é…å‡½æ•¸
            const imgSrc = getProductImageByName(product);
            document.getElementById('main-product-image').src = imgSrc;

            // æ¨™ç±¤
            let badges = '';
            if (product.is_featured) badges += '<span class="badge-detail badge-hot">ğŸ”¥ ç†±è³£å•†å“</span>';
            if (product.is_seasonal) badges += '<span class="badge-detail badge-seasonal">âœ¨ å­£ç¯€é™å®š</span>';
            document.getElementById('product-badges').innerHTML = badges;

            // è³‡è¨Š
            document.getElementById('product-title').textContent = product.name;
            document.getElementById('product-category').textContent = product.category_name || '-';
            document.getElementById('product-stock').textContent = product.stock;
            document.getElementById('product-description').textContent = product.description || '';
            document.getElementById('full-description').textContent = product.description || 'ç²¾é¸å„ªè³ªæ°´æœï¼Œç”¢åœ°ç›´é€ï¼Œå“è³ªä¿è­‰ã€‚';

            // åƒ¹æ ¼
            document.getElementById('product-price').textContent = formatPrice(product.price);

            if (product.original_price && product.original_price > product.price) {
                document.getElementById('product-original-price').textContent = formatPrice(product.original_price);
                document.getElementById('product-original-price').style.display = 'inline';

                const saved = product.original_price - product.price;
                document.getElementById('product-discount').textContent = `çœ ${formatPrice(saved)}`;
                document.getElementById('product-discount').style.display = 'inline';
            }

            // åº«å­˜ç‹€æ…‹
            const stockInfo = document.getElementById('stock-info');
            if (product.stock <= 0) {
                stockInfo.textContent = 'å·²å”®ç½„';
                stockInfo.classList.add('low');
            } else if (product.stock <= 10) {
                stockInfo.textContent = `åƒ…å‰© ${product.stock} ä»¶`;
                stockInfo.classList.add('low');
            } else {
                stockInfo.textContent = 'åº«å­˜å……è¶³';
            }

            // åˆå§‹åŒ–å°è¨ˆé¡¯ç¤º
            updateTotalPrice(1);

            // æª¢æŸ¥æ”¶è—ç‹€æ…‹
            checkFavoriteStatus();
        }

        async function loadRelatedProducts() {
            try {
                const data = await API.products.getAll({ limit: 4 });
                const related = data.products.filter(p => p.id != productId).slice(0, 4);

                document.getElementById('related-products').innerHTML = related.map(product => {
                    const imgSrc = getProductImageByName(product);
                    return `
                        <div class="product-card">
                            <a href="product-detail.html?id=${product.id}" class="product-image">
                                <img src="${imgSrc}" alt="${product.name}">
                                <div class="product-badges">
                                    ${product.is_featured ? '<span class="badge badge-hot">ğŸ”¥ ç†±è³£</span>' : ''}
                                </div>
                            </a>
                            <div class="product-info">
                                <div class="product-category">${product.category_name || ''}</div>
                                <h3 class="product-name">
                                    <a href="product-detail.html?id=${product.id}">${product.name}</a>
                                </h3>
                                <div class="product-price">
                                    <span class="current-price">${formatPrice(product.price)}</span>
                                </div>
                                <div class="product-actions">
                                    <button class="btn btn-primary" onclick="addToCart(${product.id})">
                                        <i class="fas fa-cart-plus"></i> åŠ å…¥è³¼ç‰©è»Š
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('è¼‰å…¥ç›¸é—œç”¢å“å¤±æ•—:', error);
            }
        }

        function changeQuantity(delta) {
            const input = document.getElementById('quantity');
            let value = parseInt(input.value) + delta;
            if (value < 1) value = 1;
            if (currentProduct && value > currentProduct.stock) value = currentProduct.stock;
            input.value = value;
            updateTotalPrice(value);
        }

        // æ›´æ–°ç¸½åƒ¹æ ¼é¡¯ç¤º
        function updateTotalPrice(quantity) {
            if (!currentProduct) return;

            const totalPrice = currentProduct.price * quantity;
            const priceElement = document.getElementById('product-price');

            // æ·»åŠ å‹•ç•«æ•ˆæœ
            priceElement.style.transform = 'scale(1.1)';
            priceElement.style.transition = 'transform 0.2s ease';
            priceElement.textContent = formatPrice(totalPrice);

            setTimeout(() => {
                priceElement.style.transform = 'scale(1)';
            }, 200);

            // æ›´æ–°å°è¨ˆè³‡è¨Š
            const subtotalInfo = document.getElementById('subtotal-info');
            if (subtotalInfo) {
                subtotalInfo.innerHTML = `å°è¨ˆï¼š<strong style="color: var(--accent-orange);">${formatPrice(totalPrice)}</strong>ï¼ˆ${quantity} ä»¶ Ã— ${formatPrice(currentProduct.price)}ï¼‰`;
            }

            // æ›´æ–°çœéŒ¢é‡‘é¡ (æ ¹æ“šæ•¸é‡ä¹˜ä»¥å–®å“æŠ˜æ‰£)
            if (currentProduct.original_price && currentProduct.original_price > currentProduct.price) {
                const savedPerItem = currentProduct.original_price - currentProduct.price;
                const totalSaved = savedPerItem * quantity;
                const discountElement = document.getElementById('product-discount');
                if (discountElement) {
                    discountElement.textContent = `çœ ${formatPrice(totalSaved)}`;
                    discountElement.style.display = 'inline';
                }

                // æ›´æ–°åŸåƒ¹é¡¯ç¤º (ä¹Ÿè¦ä¹˜ä»¥æ•¸é‡)
                const originalPriceElement = document.getElementById('product-original-price');
                if (originalPriceElement) {
                    originalPriceElement.textContent = formatPrice(currentProduct.original_price * quantity);
                }
            }
        }

        // ç›£è½æ•¸é‡è¼¸å…¥è®ŠåŒ–
        document.getElementById('quantity').addEventListener('input', (e) => {
            let value = parseInt(e.target.value);
            if (isNaN(value) || value < 1) value = 1;
            if (currentProduct && value > currentProduct.stock) value = currentProduct.stock;
            e.target.value = value;
            updateTotalPrice(value);
        });

        async function addToCartWithQuantity() {
            if (!currentProduct) return;

            if (!TokenManager.isLoggedIn()) {
                showToast('è«‹å…ˆç™»å…¥æœƒå“¡', 'error');
                setTimeout(() => window.location.href = 'login.html', 1500);
                return;
            }

            const quantity = parseInt(document.getElementById('quantity').value);

            try {
                await API.cart.add(currentProduct.id, quantity);
                await cart.fetch();
                showToast('å·²åŠ å…¥è³¼ç‰©è»Š', 'success');
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        function buyNow() {
            addToCartWithQuantity().then(() => {
                setTimeout(() => window.location.href = 'cart.html', 500);
            });
        }

        function showTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // ç¸®åœ–é»æ“Š
        document.querySelectorAll('.thumbnail').forEach(thumb => {
            thumb.addEventListener('click', () => {
                document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                thumb.classList.add('active');
                document.getElementById('main-product-image').src = thumb.querySelector('img').src;
            });
        });

        // åˆå§‹è¼‰å…¥
        loadProduct();

        // æ”¶è—åŠŸèƒ½
        async function toggleWishlist() {
            if (!currentProduct) return;

            if (!TokenManager.isLoggedIn()) {
                showToast('è«‹å…ˆç™»å…¥æ‰èƒ½æ”¶è—', 'error');
                setTimeout(() => window.location.href = 'login.html', 1500);
                return;
            }

            try {
                const result = await API.favorites.toggle(currentProduct.id);
                const icon = document.getElementById('wishlist-icon');
                const btn = document.getElementById('wishlist-btn');

                if (result.isFavorite) {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    btn.style.background = 'rgba(231, 76, 60, 0.2)';
                    btn.style.borderColor = '#e74c3c';
                    icon.style.color = '#e74c3c';
                    showToast('å·²åŠ å…¥æ”¶è—', 'success');
                } else {
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    btn.style.background = '';
                    btn.style.borderColor = '';
                    icon.style.color = '';
                    showToast('å·²å–æ¶ˆæ”¶è—', 'success');
                }
            } catch (error) {
                showToast('æ“ä½œå¤±æ•—ï¼š' + error.message, 'error');
            }
        }

        // æª¢æŸ¥æ˜¯å¦å·²æ”¶è—
        async function checkFavoriteStatus() {
            if (!currentProduct || !TokenManager.isLoggedIn()) return;

            try {
                const result = await API.favorites.check(currentProduct.id);
                if (result.isFavorite) {
                    const icon = document.getElementById('wishlist-icon');
                    const btn = document.getElementById('wishlist-btn');
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    btn.style.background = 'rgba(231, 76, 60, 0.2)';
                    btn.style.borderColor = '#e74c3c';
                    icon.style.color = '#e74c3c';
                }
            } catch (error) {
                console.log('æª¢æŸ¥æ”¶è—ç‹€æ…‹å¤±æ•—:', error);
            }
        }
    </script>
</body>

</html>