<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†å“ç®¡ç† | æœå¯¦æ¬é‹å·¥ å¾Œå°</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/admin/css/admin.css">
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <span>ğŸ‡</span>
                    <span>æœå¯¦æ¬é‹å·¥</span>
                </div>
                <div class="sidebar-subtitle">å¾Œå°ç®¡ç†ç³»çµ±</div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">ä¸»è¦åŠŸèƒ½</div>
                    <a href="/admin/dashboard.html" class="nav-item">
                        <i class="fas fa-chart-line"></i>
                        <span>å„€è¡¨æ¿</span>
                    </a>
                    <a href="/admin/orders.html" class="nav-item">
                        <i class="fas fa-box"></i>
                        <span>è¨‚å–®ç®¡ç†</span>
                    </a>
                    <a href="/admin/products.html" class="nav-item active">
                        <i class="fas fa-apple-alt"></i>
                        <span>å•†å“ç®¡ç†</span>
                    </a>
                    <a href="/admin/members.html" class="nav-item">
                        <i class="fas fa-users"></i>
                        <span>æœƒå“¡ç®¡ç†</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">å¿«æ·æ“ä½œ</div>
                    <a href="/frontend/" class="nav-item" target="_blank">
                        <i class="fas fa-external-link-alt"></i>
                        <span>å‰å¾€å‰å°</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <h1 class="page-title">ğŸ å•†å“ç®¡ç†</h1>
                <div class="top-bar-actions">
                    <button class="action-btn primary" onclick="openAddModal()">
                        <i class="fas fa-plus"></i> æ–°å¢å•†å“
                    </button>
                    <button class="logout-btn" title="ç™»å‡º">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <!-- Products Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>å•†å“</th>
                                    <th>åˆ†é¡</th>
                                    <th>åƒ¹æ ¼</th>
                                    <th>åº«å­˜</th>
                                    <th>æ¨™ç±¤</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="products-tbody">
                                <tr>
                                    <td colspan="6" class="loading">
                                        <div class="spinner"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Product Modal -->
    <div class="modal-overlay" id="product-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">æ–°å¢å•†å“</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="product-form">
                    <input type="hidden" id="product-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label>å•†å“åç¨± *</label>
                            <input type="text" id="name" required>
                        </div>
                        <div class="form-group">
                            <label>åˆ†é¡</label>
                            <select id="category_id">
                                <option value="">é¸æ“‡åˆ†é¡</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å•†å“æè¿°</label>
                        <textarea id="description" rows="3"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å”®åƒ¹ *</label>
                            <input type="number" id="price" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>åŸåƒ¹</label>
                            <input type="number" id="original_price" min="0">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>åº«å­˜æ•¸é‡</label>
                            <input type="number" id="stock" min="0" value="0">
                        </div>
                        <div class="form-group">
                            <label>å•†å“åœ–ç‰‡</label>
                            <div id="image-upload-area"
                                style="border: 2px dashed rgba(255,255,255,0.3); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s;"
                                onclick="document.getElementById('image-file').click()">
                                <input type="file" id="image-file" accept="image/*" style="display: none;"
                                    onchange="handleImageUpload(this)">
                                <div id="upload-placeholder">
                                    <i class="fas fa-cloud-upload-alt"
                                        style="font-size: 2rem; color: rgba(255,255,255,0.5); margin-bottom: 10px;"></i>
                                    <p style="margin: 0; color: rgba(255,255,255,0.7);">
                                        é»æ“Šä¸Šå‚³åœ–ç‰‡<br><small>æˆ–æ‹–æ”¾åœ–ç‰‡åˆ°æ­¤è™•</small></p>
                                </div>
                                <div id="image-preview" style="display: none;">
                                    <img id="preview-img" src=""
                                        style="max-width: 100%; max-height: 150px; border-radius: 8px;">
                                    <p id="preview-name"
                                        style="margin: 10px 0 0; font-size: 0.85rem; color: rgba(255,255,255,0.7);"></p>
                                </div>
                            </div>
                            <input type="hidden" id="image_url">
                            <div style="margin-top: 10px;">
                                <small style="color: rgba(255,255,255,0.5);">æˆ–è¼¸å…¥åœ–ç‰‡ç¶²å€ï¼š</small>
                                <input type="text" id="image_url_manual" placeholder="https://..."
                                    onchange="document.getElementById('image_url').value = this.value"
                                    style="margin-top: 5px;">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å•†å“æ¨™ç±¤</label>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="is_featured">
                                <span>ğŸ”¥ ç†±é–€ç²¾é¸</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="is_seasonal">
                                <span>ğŸŒ¸ å­£ç¯€é™å®š</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="action-btn outline" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="action-btn primary" onclick="saveProduct()">å„²å­˜</button>
            </div>
        </div>
    </div>

    <script src="/admin/js/api.js"></script>
    <script>
        if (!checkAdminAuth()) { }

        let products = [];
        let categories = [];
        let editingId = null;

        async function loadCategories() {
            try {
                const data = await AdminAPI.categories.getAll();
                categories = data.categories;

                const select = document.getElementById('category_id');
                select.innerHTML = '<option value="">é¸æ“‡åˆ†é¡</option>' +
                    categories.map(cat => `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`).join('');
            } catch (error) {
                console.error('è¼‰å…¥åˆ†é¡å¤±æ•—:', error);
            }
        }

        async function loadProducts() {
            try {
                const data = await AdminAPI.products.getAll();
                products = data.products;
                renderProducts();
            } catch (error) {
                console.error('è¼‰å…¥å•†å“å¤±æ•—:', error);
                showToast('è¼‰å…¥å•†å“å¤±æ•—', 'error');
            }
        }

        function renderProducts() {
            const tbody = document.getElementById('products-tbody');

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">æ²’æœ‰å•†å“</td></tr>';
                return;
            }

            tbody.innerHTML = products.map(product => `
                <tr>
                    <td>
                        <div class="product-row">
                            <div class="product-thumb">
                                ${product.image_url
                    ? `<img src="${product.image_url}" alt="${product.name}" onerror="this.parentElement.innerHTML='ğŸ'">`
                    : 'ğŸ'
                }
                            </div>
                            <div>
                                <strong>${product.name}</strong>
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    ${product.description || ''}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td>${product.category_name || '-'}</td>
                    <td>
                        <div><strong style="color: var(--accent-orange);">${formatPrice(product.price)}</strong></div>
                        ${product.original_price > product.price
                    ? `<div style="font-size: 0.85rem; color: rgba(255,255,255,0.5); text-decoration: line-through;">${formatPrice(product.original_price)}</div>`
                    : ''
                }
                    </td>
                    <td>
                        <span style="color: ${product.stock <= 10 ? 'var(--accent-red)' : 'var(--primary-light)'};">
                            ${product.stock}
                        </span>
                    </td>
                    <td>
                        ${product.is_featured ? '<span class="status-badge status-completed">ç†±é–€</span>' : ''}
                        ${product.is_seasonal ? '<span class="status-badge status-processing">å­£ç¯€</span>' : ''}
                    </td>
                    <td>
                        <button class="action-btn outline" onclick="editProduct(${product.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn danger" onclick="deleteProduct(${product.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function openAddModal() {
            editingId = null;
            document.getElementById('modal-title').textContent = 'æ–°å¢å•†å“';
            document.getElementById('product-form').reset();
            document.getElementById('product-modal').classList.add('show');
        }

        function editProduct(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            editingId = id;
            document.getElementById('modal-title').textContent = 'ç·¨è¼¯å•†å“';
            document.getElementById('product-id').value = id;
            document.getElementById('name').value = product.name;
            document.getElementById('category_id').value = product.category_id || '';
            document.getElementById('description').value = product.description || '';
            document.getElementById('price').value = product.price;
            document.getElementById('original_price').value = product.original_price || '';
            document.getElementById('stock').value = product.stock || 0;
            document.getElementById('image_url').value = product.image_url || '';
            document.getElementById('is_featured').checked = product.is_featured;
            document.getElementById('is_seasonal').checked = product.is_seasonal;

            document.getElementById('product-modal').classList.add('show');
        }

        async function saveProduct() {
            const productData = {
                name: document.getElementById('name').value.trim(),
                category_id: document.getElementById('category_id').value || null,
                description: document.getElementById('description').value.trim(),
                price: parseFloat(document.getElementById('price').value) || 0,
                original_price: parseFloat(document.getElementById('original_price').value) || null,
                stock: parseInt(document.getElementById('stock').value) || 0,
                image_url: document.getElementById('image_url').value.trim() || null,
                is_featured: document.getElementById('is_featured').checked,
                is_seasonal: document.getElementById('is_seasonal').checked
            };

            if (!productData.name || !productData.price) {
                showToast('è«‹å¡«å¯«å•†å“åç¨±å’Œåƒ¹æ ¼', 'error');
                return;
            }

            try {
                if (editingId) {
                    await AdminAPI.products.update(editingId, productData);
                    showToast('å•†å“å·²æ›´æ–°', 'success');
                } else {
                    await AdminAPI.products.create(productData);
                    showToast('å•†å“å·²æ–°å¢', 'success');
                }

                closeModal();
                loadProducts();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function deleteProduct(id) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å•†å“å—ï¼Ÿ')) return;

            try {
                await AdminAPI.products.delete(id);
                showToast('å•†å“å·²åˆªé™¤', 'success');
                loadProducts();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        function closeModal() {
            document.getElementById('product-modal').classList.remove('show');
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
            loadProducts();

            // æ‹–æ”¾ä¸Šå‚³
            const uploadArea = document.getElementById('image-upload-area');
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#4caf50';
                uploadArea.style.background = 'rgba(76, 175, 80, 0.1)';
            });
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = 'rgba(255,255,255,0.3)';
                uploadArea.style.background = 'transparent';
            });
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'rgba(255,255,255,0.3)';
                uploadArea.style.background = 'transparent';
                if (e.dataTransfer.files.length > 0) {
                    document.getElementById('image-file').files = e.dataTransfer.files;
                    handleImageUpload(document.getElementById('image-file'));
                }
            });
        });

        // åœ–ç‰‡ä¸Šå‚³è™•ç†
        async function handleImageUpload(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            if (!file.type.startsWith('image/')) {
                showToast('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆ', 'error');
                return;
            }

            // é¡¯ç¤ºé è¦½
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('upload-placeholder').style.display = 'none';
                document.getElementById('image-preview').style.display = 'block';
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('preview-name').textContent = file.name;
            };
            reader.readAsDataURL(file);

            // ä¸Šå‚³åˆ°ä¼ºæœå™¨
            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${TokenManager.get()}`
                    },
                    body: formData
                });
                const data = await response.json();
                if (data.url) {
                    document.getElementById('image_url').value = data.url;
                    showToast('åœ–ç‰‡ä¸Šå‚³æˆåŠŸ', 'success');
                } else {
                    throw new Error(data.error || 'ä¸Šå‚³å¤±æ•—');
                }
            } catch (error) {
                showToast('åœ–ç‰‡ä¸Šå‚³å¤±æ•—: ' + error.message, 'error');
            }
        }
    </script>
</body>

</html>