<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚å–®ç®¡ç† | æœå¯¦æ¬é‹å·¥ å¾Œå°</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/admin/css/admin.css">
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <span>ğŸ‡</span>
                    <span>æœå¯¦æ¬é‹å·¥</span>
                </div>
                <div class="sidebar-subtitle">å¾Œå°ç®¡ç†ç³»çµ±</div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">ä¸»è¦åŠŸèƒ½</div>
                    <a href="/admin/dashboard.html" class="nav-item">
                        <i class="fas fa-chart-line"></i>
                        <span>å„€è¡¨æ¿</span>
                    </a>
                    <a href="/admin/orders.html" class="nav-item active">
                        <i class="fas fa-box"></i>
                        <span>è¨‚å–®ç®¡ç†</span>
                    </a>
                    <a href="/admin/products.html" class="nav-item">
                        <i class="fas fa-apple-alt"></i>
                        <span>å•†å“ç®¡ç†</span>
                    </a>
                    <a href="/admin/members.html" class="nav-item">
                        <i class="fas fa-users"></i>
                        <span>æœƒå“¡ç®¡ç†</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">å¿«æ·æ“ä½œ</div>
                    <a href="/frontend/" class="nav-item" target="_blank">
                        <i class="fas fa-external-link-alt"></i>
                        <span>å‰å¾€å‰å°</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <h1 class="page-title">ğŸ“¦ è¨‚å–®ç®¡ç†</h1>
                <div class="top-bar-actions">
                    <button class="logout-btn" title="ç™»å‡º">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <!-- Summary Bar -->
            <div class="summary-bar" id="summary-bar">
                <div class="summary-item">
                    <span class="label">ğŸ“Š è¨‚å–®æ•¸é‡ï¼š</span>
                    <span class="value" id="summary-count">0</span>
                </div>
                <div class="summary-item">
                    <span class="label">ğŸ’° ç¸½é‡‘é¡ï¼š</span>
                    <span class="value" id="summary-total">$0</span>
                </div>
                <div class="summary-item">
                    <span class="label">â³ å¾…è™•ç†ï¼š</span>
                    <span class="value" id="summary-pending" style="color: var(--accent-gold);">0</span>
                </div>
                <div class="summary-item">
                    <span class="label">âœ… å·²å®Œæˆï¼š</span>
                    <span class="value" id="summary-completed" style="color: var(--primary-light);">0</span>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="filter-bar">
                <div class="search-input">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" placeholder="æœå°‹è¨‚å–®ç·¨è™Ÿã€é¡§å®¢åç¨±...">
                </div>
                <select class="filter-select" id="date-filter">
                    <option value="">å…¨éƒ¨æ™‚é–“</option>
                    <option value="today">ğŸ“… ä»Šå¤©</option>
                    <option value="yesterday">ğŸ“… æ˜¨å¤©</option>
                    <option value="this-week">ğŸ“… æœ¬é€±</option>
                    <option value="this-month">ğŸ“… æœ¬æœˆ</option>
                    <option value="last-month">ğŸ“… ä¸Šæœˆ</option>
                    <option value="last-year">ğŸ“… å»å¹´</option>
                </select>
                <select class="filter-select" id="status-filter">
                    <option value="">å…¨éƒ¨ç‹€æ…‹</option>
                    <option value="pending">ğŸŸ¡ å¾…è™•ç†</option>
                    <option value="processing">ğŸ”µ è™•ç†ä¸­</option>
                    <option value="shipped">ğŸŸ£ å·²å‡ºè²¨</option>
                    <option value="completed">ğŸŸ¢ å·²å®Œæˆ</option>
                    <option value="cancelled">ğŸ”´ å·²å–æ¶ˆ</option>
                </select>
            </div>

            <!-- Orders Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>è¨‚å–®ç·¨è™Ÿ</th>
                                    <th>é¡§å®¢</th>
                                    <th>é‡‘é¡</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>ä¸‹å–®æ™‚é–“</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="orders-tbody">
                                <tr>
                                    <td colspan="6" class="loading">
                                        <div class="spinner"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal-overlay" id="order-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>è¨‚å–®è©³æƒ…</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="order-detail">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-btn outline" onclick="closeModal()">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- Cancel Order Modal -->
    <div class="modal-overlay" id="cancel-modal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle" style="color: #f39c12;"></i> å–æ¶ˆè¨‚å–®</h3>
                <button class="modal-close" onclick="closeCancelModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px;">è¨‚å–®ç·¨è™Ÿï¼š<strong id="cancel-order-info"></strong></p>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: rgba(255,255,255,0.8);">å–æ¶ˆåŸå› ï¼ˆé¸å¡«ï¼‰ï¼š</label>
                    <select id="cancel-reason"
                        style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: var(--bg-dark); color: #fff;">
                        <option value="">-- è«‹é¸æ“‡åŸå›  --</option>
                        <option value="å®¢æˆ¶è¦æ±‚å–æ¶ˆ">å®¢æˆ¶è¦æ±‚å–æ¶ˆ</option>
                        <option value="åº«å­˜ä¸è¶³">åº«å­˜ä¸è¶³</option>
                        <option value="ä»˜æ¬¾å•é¡Œ">ä»˜æ¬¾å•é¡Œ</option>
                        <option value="é…é€å•é¡Œ">é…é€å•é¡Œ</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>

                <div style="margin-bottom: 15px;">
                    <label
                        style="display: block; margin-bottom: 8px; color: rgba(255,255,255,0.8);">çµ¦æœƒå“¡çš„å‚™è¨»ï¼ˆæœƒé¡¯ç¤ºåœ¨æœƒå“¡è¨‚å–®ä¸­ï¼‰ï¼š</label>
                    <textarea id="admin-note" rows="3" placeholder="å¦‚ï¼šå¾ˆæŠ±æ­‰ï¼Œå› åº«å­˜ä¸è¶³ç„¡æ³•å‡ºè²¨ï¼Œé¡åº¦å·²é€€é‚„..."
                        style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: var(--bg-dark); color: #fff; resize: vertical;"></textarea>
                </div>

                <p style="color: #e74c3c; font-size: 0.9rem; margin-bottom: 10px;">
                    <i class="fas fa-info-circle"></i> å–æ¶ˆå¾Œå°‡è‡ªå‹•é€€é‚„æœƒå“¡é¡åº¦ä¸¦æ¢å¾©åº«å­˜
                </p>
            </div>
            <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="action-btn outline" onclick="closeCancelModal()">è¿”å›</button>
                <button class="action-btn" style="background: #7f8c8d;" onclick="confirmCancel(false)">ç›´æ¥å–æ¶ˆ</button>
                <button class="action-btn" style="background: #e74c3c;" onclick="confirmCancel(true)">å–æ¶ˆä¸¦å‚™è¨»</button>
            </div>
        </div>
    </div>

    <script src="/admin/js/api.js"></script>
    <script>
        if (!checkAdminAuth()) { }

        let allOrders = [];
        let filteredOrders = [];

        // æ—¥æœŸç¯„åœè¨ˆç®—
        function getDateRange(filter) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            switch (filter) {
                case 'today':
                    return { start: today, end: new Date(today.getTime() + 24 * 60 * 60 * 1000) };
                case 'yesterday':
                    const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                    return { start: yesterday, end: today };
                case 'this-week':
                    const weekStart = new Date(today);
                    weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                    return { start: weekStart, end: new Date(today.getTime() + 24 * 60 * 60 * 1000) };
                case 'this-month':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    return { start: monthStart, end: new Date(today.getTime() + 24 * 60 * 60 * 1000) };
                case 'last-month':
                    const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 1);
                    return { start: lastMonthStart, end: lastMonthEnd };
                case 'last-year':
                    const lastYearStart = new Date(now.getFullYear() - 1, 0, 1);
                    const lastYearEnd = new Date(now.getFullYear(), 0, 1);
                    return { start: lastYearStart, end: lastYearEnd };
                default:
                    return null;
            }
        }

        async function loadOrders() {
            try {
                const data = await AdminAPI.orders.getAll({});
                allOrders = data.orders || [];
                applyFilters();
            } catch (error) {
                console.error('è¼‰å…¥è¨‚å–®å¤±æ•—:', error);
                showToast('è¼‰å…¥è¨‚å–®å¤±æ•—', 'error');
            }
        }

        function applyFilters() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const status = document.getElementById('status-filter').value;
            const dateFilter = document.getElementById('date-filter').value;
            const dateRange = getDateRange(dateFilter);

            filteredOrders = allOrders.filter(order => {
                // æœå°‹ç¯©é¸
                if (search) {
                    const orderNum = (order.order_number || '').toLowerCase();
                    const customerName = (order.customer_name || '').toLowerCase();
                    const customerEmail = (order.customer_email || '').toLowerCase();
                    if (!orderNum.includes(search) && !customerName.includes(search) && !customerEmail.includes(search)) {
                        return false;
                    }
                }

                // ç‹€æ…‹ç¯©é¸
                if (status && order.status !== status) {
                    return false;
                }

                // æ—¥æœŸç¯©é¸
                if (dateRange) {
                    const orderDate = new Date(order.created_at);
                    if (orderDate < dateRange.start || orderDate >= dateRange.end) {
                        return false;
                    }
                }

                return true;
            });

            updateSummary();
            renderOrders();
        }

        function updateSummary() {
            const totalCount = filteredOrders.length;
            const totalAmount = filteredOrders.reduce((sum, order) => sum + (order.total_amount || 0), 0);
            const pendingCount = filteredOrders.filter(o => o.status === 'pending').length;
            const completedCount = filteredOrders.filter(o => o.status === 'completed').length;

            document.getElementById('summary-count').textContent = totalCount;
            document.getElementById('summary-total').textContent = formatPrice(totalAmount);
            document.getElementById('summary-pending').textContent = pendingCount;
            document.getElementById('summary-completed').textContent = completedCount;
        }

        function renderOrders() {
            const tbody = document.getElementById('orders-tbody');

            if (filteredOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">æ²’æœ‰æ‰¾åˆ°è¨‚å–®</td></tr>';
                return;
            }

            tbody.innerHTML = filteredOrders.map(order => `
                <tr>
                    <td><strong>${order.order_number}</strong></td>
                    <td>
                        <div>${order.customer_name || 'è¨ªå®¢'}</div>
                        <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">${order.customer_email || ''}</div>
                    </td>
                    <td><strong style="color: var(--accent-orange);">${formatPrice(order.total_amount)}</strong></td>
                    <td>
                        <select class="status-select" onchange="updateStatus(${order.id}, this.value)" style="padding: 6px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.1); color: var(--white); cursor: pointer;">
                            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>ğŸŸ¡ å¾…è™•ç†</option>
                            <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>ğŸ”µ è™•ç†ä¸­</option>
                            <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>ğŸŸ£ å·²å‡ºè²¨</option>
                            <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>ğŸŸ¢ å·²å®Œæˆ</option>
                            <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>ğŸ”´ å·²å–æ¶ˆ</option>
                        </select>
                    </td>
                    <td>${formatDate(order.created_at)}</td>
                    <td>
                        <button class="action-btn outline" onclick="viewOrder(${order.id})">
                            <i class="fas fa-eye"></i> æŸ¥çœ‹
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function updateStatus(orderId, status) {
            // å¦‚æœæ˜¯å–æ¶ˆè¨‚å–®ï¼Œé¡¯ç¤ºå‚™è¨»å½ˆçª—
            if (status === 'cancelled') {
                showCancelModal(orderId);
                return;
            }

            try {
                await AdminAPI.orders.updateStatus(orderId, status);
                showToast('è¨‚å–®ç‹€æ…‹å·²æ›´æ–°', 'success');
                // æ›´æ–°æœ¬åœ°æ•¸æ“š
                const order = allOrders.find(o => o.id === orderId);
                if (order) {
                    order.status = status;
                    applyFilters();
                }
            } catch (error) {
                showToast(error.message, 'error');
                loadOrders(); // é‡æ–°è¼‰å…¥
            }
        }

        let currentCancelOrderId = null;

        function showCancelModal(orderId) {
            currentCancelOrderId = orderId;
            const order = allOrders.find(o => o.id === orderId);
            document.getElementById('cancel-order-info').textContent = order ? order.order_number : '';
            document.getElementById('cancel-reason').value = '';
            document.getElementById('admin-note').value = '';
            document.getElementById('cancel-modal').classList.add('show');
        }

        function closeCancelModal() {
            document.getElementById('cancel-modal').classList.remove('show');
            currentCancelOrderId = null;
            // æ¢å¾©ä¸‹æ‹‰é¸å–®çš„ç‹€æ…‹
            loadOrders();
        }

        async function confirmCancel(withNote = true) {
            const cancel_reason = document.getElementById('cancel-reason').value;
            const admin_note = document.getElementById('admin-note').value;

            try {
                await AdminAPI.orders.updateStatus(currentCancelOrderId, 'cancelled', {
                    cancel_reason: cancel_reason || null,
                    admin_note: admin_note || null
                });
                showToast('è¨‚å–®å·²å–æ¶ˆ' + (withNote && (cancel_reason || admin_note) ? 'ï¼ˆå«å‚™è¨»ï¼‰' : ''), 'success');
                closeCancelModal();
                loadOrders();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function viewOrder(orderId) {
            const modal = document.getElementById('order-modal');
            const detailContainer = document.getElementById('order-detail');

            modal.classList.add('show');
            detailContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

            try {
                const { order, items } = await AdminAPI.orders.getById(orderId);

                detailContainer.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px;">è¨‚å–®ç·¨è™Ÿï¼š${order.order_number}</h4>
                        <span class="status-badge status-${order.status}">${getStatusText(order.status)}</span>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <h5 style="margin-bottom: 10px; color: rgba(255,255,255,0.8);">æ”¶ä»¶è³‡è¨Š</h5>
                        <p><strong>æ”¶ä»¶äººï¼š</strong>${order.shipping_name}</p>
                        <p><strong>é›»è©±ï¼š</strong>${order.shipping_phone}</p>
                        <p><strong>åœ°å€ï¼š</strong>${order.shipping_address}</p>
                        ${order.notes ? `<p><strong>å‚™è¨»ï¼š</strong>${order.notes}</p>` : ''}
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.05); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <h5 style="margin-bottom: 10px; color: rgba(255,255,255,0.8);">å•†å“æ˜ç´°</h5>
                        ${items.map(item => `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <span>${item.name || 'å•†å“'} x ${item.quantity}</span>
                                <span>${formatPrice(item.unit_price * item.quantity)}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: right; font-size: 1.2rem;">
                        <strong>ç¸½é‡‘é¡ï¼š<span style="color: var(--accent-orange);">${formatPrice(order.total_amount)}</span></strong>
                    </div>
                `;
            } catch (error) {
                detailContainer.innerHTML = '<p style="color: var(--accent-red);">è¼‰å…¥å¤±æ•—</p>';
            }
        }

        function closeModal() {
            document.getElementById('order-modal').classList.remove('show');
        }

        // æœå°‹å’Œç¯©é¸äº‹ä»¶
        document.getElementById('search-input').addEventListener('input', debounce(applyFilters, 300));
        document.getElementById('status-filter').addEventListener('change', applyFilters);
        document.getElementById('date-filter').addEventListener('change', applyFilters);

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        document.addEventListener('DOMContentLoaded', loadOrders);
    </script>
</body>

</html>