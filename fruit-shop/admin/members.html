<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒå“¡ç®¡ç† | æœå¯¦æ¬é‹å·¥ å¾Œå°</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/admin/css/admin.css">
    <style>
        /* æœƒå“¡ç‹€æ…‹æ¨™ç±¤ */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-active {
            background: rgba(45, 138, 78, 0.2);
            color: #2d8a4e;
        }

        .status-suspended {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
        }

        .status-deleted {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        /* æ“ä½œä¸‹æ‹‰é¸å–® */
        .action-dropdown {
            position: relative;
            display: inline-block;
        }

        .action-btn {
            padding: 8px 16px;
            border-radius: 8px;
            background: var(--bg-glass);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .action-btn:hover {
            border-color: var(--primary-color);
            background: rgba(45, 138, 78, 0.1);
        }

        .action-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: #2a2a2a;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            min-width: 160px;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s;
        }

        .action-dropdown.open .action-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .action-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s;
        }

        .action-menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .action-menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .action-menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .action-menu-item.active-item {
            color: #2d8a4e;
        }

        .action-menu-item.suspend-item {
            color: #f39c12;
        }

        .action-menu-item.delete-item {
            color: #e74c3c;
        }

        .action-menu-item i {
            width: 18px;
            text-align: center;
        }

        /* çµ±è¨ˆæ‘˜è¦ */
        .members-summary {
            display: flex;
            gap: 20px;
            padding: 16px 20px;
            background: rgba(45, 138, 78, 0.1);
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .summary-stat {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .summary-stat .label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .summary-stat .value {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--accent-orange);
        }

        /* ç‹€æ…‹ç¯©é¸æŒ‰éˆ• */
        .status-filters {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .status-filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            background: var(--bg-glass);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .status-filter-btn.active,
        .status-filter-btn:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: #fff;
        }

        /* ç¢ºèªå°è©±æ¡† */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .confirm-modal.show {
            opacity: 1;
            visibility: visible;
        }

        .confirm-dialog {
            background: #2a2a2a;
            border-radius: 16px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .confirm-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .confirm-icon.warning {
            color: #f39c12;
        }

        .confirm-icon.danger {
            color: #e74c3c;
        }

        .confirm-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .confirm-message {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 25px;
        }

        .confirm-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-actions .btn {
            min-width: 100px;
        }

        .btn-danger {
            background: #e74c3c;
            color: #fff;
        }

        .btn-warning {
            background: #f39c12;
            color: #fff;
        }
    </style>
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <span>ğŸ‡</span>
                    <span>æœå¯¦æ¬é‹å·¥</span>
                </div>
                <div class="sidebar-subtitle">å¾Œå°ç®¡ç†ç³»çµ±</div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">ä¸»è¦åŠŸèƒ½</div>
                    <a href="/admin/dashboard.html" class="nav-item">
                        <i class="fas fa-chart-line"></i>
                        <span>å„€è¡¨æ¿</span>
                    </a>
                    <a href="/admin/orders.html" class="nav-item">
                        <i class="fas fa-box"></i>
                        <span>è¨‚å–®ç®¡ç†</span>
                    </a>
                    <a href="/admin/products.html" class="nav-item">
                        <i class="fas fa-apple-alt"></i>
                        <span>å•†å“ç®¡ç†</span>
                    </a>
                    <a href="/admin/members.html" class="nav-item active">
                        <i class="fas fa-users"></i>
                        <span>æœƒå“¡ç®¡ç†</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">å¿«æ·æ“ä½œ</div>
                    <a href="/frontend/" class="nav-item" target="_blank">
                        <i class="fas fa-external-link-alt"></i>
                        <span>å‰å¾€å‰å°</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <h1 class="page-title">ğŸ‘¥ æœƒå“¡ç®¡ç†</h1>
                <div class="top-bar-actions">
                    <button class="logout-btn" title="ç™»å‡º">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <!-- æœƒå“¡çµ±è¨ˆ -->
            <div class="members-summary">
                <div class="summary-stat">
                    <span class="label">ğŸ“Š ç¸½æœƒå“¡æ•¸ï¼š</span>
                    <span class="value" id="total-members">0</span>
                </div>
                <div class="summary-stat">
                    <span class="label">âœ… æ­£å¸¸ï¼š</span>
                    <span class="value" id="active-members" style="color: #2d8a4e;">0</span>
                </div>
                <div class="summary-stat">
                    <span class="label">â¸ï¸ åœç”¨ï¼š</span>
                    <span class="value" id="suspended-members" style="color: #f39c12;">0</span>
                </div>
                <div class="summary-stat">
                    <span class="label">ğŸ’° ç¸½æ¶ˆè²»ï¼š</span>
                    <span class="value" id="total-revenue">$0</span>
                </div>

                <!-- ç‹€æ…‹ç¯©é¸ -->
                <div class="status-filters">
                    <button class="status-filter-btn active" data-status="all">å…¨éƒ¨</button>
                    <button class="status-filter-btn" data-status="active">æ­£å¸¸</button>
                    <button class="status-filter-btn" data-status="suspended">åœç”¨</button>
                </div>
            </div>

            <!-- Filter Bar -->
            <div class="filter-bar">
                <div class="search-input">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" placeholder="æœå°‹æœƒå“¡åç¨±ã€Emailã€é›»è©±...">
                </div>
            </div>

            <!-- Members Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>æœƒå“¡</th>
                                    <th>é›»è©±</th>
                                    <th>ç‹€æ…‹</th>
                                    <th>ğŸ’° é¡åº¦</th>
                                    <th>è¨‚å–®æ•¸</th>
                                    <th>æ¶ˆè²»ç¸½é¡</th>
                                    <th>è¨»å†Šæ™‚é–“</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="members-tbody">
                                <tr>
                                    <td colspan="8" class="loading">
                                        <div class="spinner"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ç¢ºèªå°è©±æ¡† -->
    <div class="confirm-modal" id="confirm-modal">
        <div class="confirm-dialog">
            <div class="confirm-icon" id="confirm-icon">âš ï¸</div>
            <h3 class="confirm-title" id="confirm-title">ç¢ºèªæ“ä½œ</h3>
            <p class="confirm-message" id="confirm-message">ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p>
            <div class="confirm-actions">
                <button class="btn btn-secondary" onclick="closeConfirmModal()">å–æ¶ˆ</button>
                <button class="btn" id="confirm-btn" onclick="executeAction()">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- é¡åº¦èª¿æ•´å°è©±æ¡† -->
    <div class="confirm-modal" id="credit-modal">
        <div class="confirm-dialog"
            style="max-width: 480px; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid #ff9800;">
            <div class="confirm-icon" style="font-size: 4rem; margin-bottom: 10px;">ğŸ’°</div>
            <h3 class="confirm-title"
                style="color: #ffffff; font-size: 1.6rem; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.5);">
                èª¿æ•´æœƒå“¡é¡åº¦</h3>
            <p class="confirm-message" id="credit-member-name"
                style="color: #ffeb3b; font-weight: 700; font-size: 1.3rem; margin: 15px 0;">æœƒå“¡åç¨±</p>
            <div style="margin-bottom: 20px; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 12px;">
                <div
                    style="display: flex; gap: 15px; justify-content: center; align-items: center; margin-bottom: 20px;">
                    <span style="color: #ffffff; font-weight: 600; font-size: 1.1rem;">ç›®å‰é¡åº¦ï¼š</span>
                    <strong id="current-credit"
                        style="color: #00ff88; font-size: 2rem; font-weight: 800; text-shadow: 0 0 20px rgba(0, 255, 136, 0.8);">$0</strong>
                </div>
                <div style="display: flex; gap: 12px; align-items: center; justify-content: center; flex-wrap: wrap;">
                    <input type="number" id="credit-amount" placeholder="é‡‘é¡" style="
                        width: 100px; padding: 12px; border-radius: 8px; 
                        background: #ffffff; border: 2px solid #ff9800;
                        color: #333; font-size: 1.1rem; text-align: center; font-weight: 700;">
                    <button class="btn" onclick="adjustCredit(1)"
                        style="padding: 12px 20px; background: #4caf50; color: #fff; font-weight: 700; font-size: 1rem;">â•
                        å¢åŠ </button>
                    <button class="btn" onclick="adjustCredit(-1)"
                        style="padding: 12px 20px; background: #f44336; color: #fff; font-weight: 700; font-size: 1rem;">â–
                        æ¸›å°‘</button>
                </div>
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.2);">
                    <span style="color: #ffffff; font-size: 0.95rem;">æˆ–ç›´æ¥è¨­å®šé¡åº¦ï¼š</span>
                    <button class="btn" onclick="setCredit()"
                        style="padding: 10px 20px; margin-left: 10px; background: #ff9800; color: #000; font-weight: 700;">è¨­å®šç‚ºæ­¤é‡‘é¡</button>
                </div>
            </div>
            <div class="confirm-actions">
                <button class="btn" onclick="closeCreditModal()"
                    style="padding: 12px 30px; background: #666; color: #fff; font-size: 1rem;">é—œé–‰</button>
            </div>
        </div>
    </div>

    <script src="/admin/js/api.js"></script>
    <script>
        if (!checkAdminAuth()) { }

        let members = [];
        let currentFilter = 'all';
        let pendingAction = null;

        async function loadMembers() {
            const search = document.getElementById('search-input').value;

            try {
                const params = {};
                if (search) params.search = search;

                const data = await AdminAPI.members.getAll(params);
                members = data.members.map(m => ({
                    ...m,
                    status: m.status || 'active' // é è¨­ç‹€æ…‹ç‚ºæ­£å¸¸
                }));
                updateStats();
                renderMembers();
            } catch (error) {
                console.error('è¼‰å…¥æœƒå“¡å¤±æ•—:', error);
                showToast('è¼‰å…¥æœƒå“¡å¤±æ•—', 'error');
            }
        }

        function updateStats() {
            const active = members.filter(m => m.status === 'active').length;
            const suspended = members.filter(m => m.status === 'suspended').length;
            const totalSpent = members.reduce((sum, m) => sum + (m.total_spent || 0), 0);

            document.getElementById('total-members').textContent = members.length;
            document.getElementById('active-members').textContent = active;
            document.getElementById('suspended-members').textContent = suspended;
            document.getElementById('total-revenue').textContent = formatPrice(totalSpent);
        }

        function getFilteredMembers() {
            if (currentFilter === 'all') return members;
            return members.filter(m => m.status === currentFilter);
        }

        function renderMembers() {
            const tbody = document.getElementById('members-tbody');
            const filtered = getFilteredMembers();

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">æ²’æœ‰æ‰¾åˆ°æœƒå“¡</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(member => {
                const statusBadge = getStatusBadge(member.status);
                const isActive = member.status === 'active' || !member.status;
                return `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: ${getAvatarColor(member.status)}; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                                ğŸ‘¤
                            </div>
                            <div>
                                <strong>${member.name}</strong>
                                <div style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">${member.email}</div>
                            </div>
                        </div>
                    </td>
                    <td>${member.phone || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <span style="display: inline-flex; align-items: center; gap: 8px;">
                            <strong style="color: ${(member.credit || 0) > 0 ? '#f4a261' : 'rgba(255,255,255,0.5)'};">$${(member.credit || 0).toLocaleString()}</strong>
                            <button class="action-btn" style="padding: 4px 10px; font-size: 0.8rem;" onclick="openCreditModal(${member.id}, '${member.name.replace(/'/g, "\\'")}', ${member.credit || 0})">
                                <i class="fas fa-edit"></i>
                            </button>
                        </span>
                    </td>
                    <td><strong>${member.order_count}</strong> ç­†</td>
                    <td><strong style="color: var(--accent-orange);">${formatPrice(member.total_spent)}</strong></td>
                    <td>${formatDate(member.created_at)}</td>
                    <td>
                        <div class="action-dropdown" data-id="${member.id}">
                            <button class="action-btn" onclick="event.stopPropagation(); toggleActionMenu(${member.id})">
                                <i class="fas fa-ellipsis-v"></i>
                                æ“ä½œ
                            </button>
                            <div class="action-menu">
                                ${isActive ? `
                                    <div class="action-menu-item suspend-item" onclick="event.stopPropagation(); confirmSuspend(${member.id}, '${member.name.replace(/'/g, "\\'")}')">
                                        <i class="fas fa-pause-circle"></i>
                                        åœç”¨å¸³è™Ÿ
                                    </div>
                                ` : `
                                    <div class="action-menu-item active-item" onclick="event.stopPropagation(); confirmActivate(${member.id}, '${member.name.replace(/'/g, "\\'")}')">
                                        <i class="fas fa-check-circle"></i>
                                        å•Ÿç”¨å¸³è™Ÿ
                                    </div>
                                `}
                                <div class="action-menu-item delete-item" onclick="event.stopPropagation(); confirmDelete(${member.id}, '${member.name.replace(/'/g, "\\'")}')">
                                    <i class="fas fa-trash-alt"></i>
                                    åˆªé™¤å¸³è™Ÿ
                                </div>
                            </div>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }

        function getStatusBadge(status) {
            switch (status) {
                case 'active':
                    return '<span class="status-badge status-active"><i class="fas fa-check-circle"></i> æ­£å¸¸</span>';
                case 'suspended':
                    return '<span class="status-badge status-suspended"><i class="fas fa-pause-circle"></i> åœç”¨</span>';
                default:
                    return '<span class="status-badge status-active"><i class="fas fa-check-circle"></i> æ­£å¸¸</span>';
            }
        }

        function getAvatarColor(status) {
            switch (status) {
                case 'active': return 'var(--primary-color)';
                case 'suspended': return '#f39c12';
                default: return 'var(--primary-color)';
            }
        }

        function toggleActionMenu(memberId) {
            // é—œé–‰å…¶ä»–å·²é–‹å•Ÿçš„é¸å–®
            document.querySelectorAll('.action-dropdown.open').forEach(d => {
                if (d.dataset.id != memberId) {
                    d.classList.remove('open');
                }
            });

            const dropdown = document.querySelector(`.action-dropdown[data-id="${memberId}"]`);
            dropdown.classList.toggle('open');
        }

        // é»æ“Šå¤–éƒ¨é—œé–‰é¸å–®
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.action-dropdown')) {
                document.querySelectorAll('.action-dropdown.open').forEach(d => d.classList.remove('open'));
            }
        });

        // ç¢ºèªæ“ä½œç›¸é—œ
        function confirmSuspend(memberId, memberName) {
            pendingAction = { type: 'suspend', memberId, memberName };
            document.getElementById('confirm-icon').textContent = 'â¸ï¸';
            document.getElementById('confirm-icon').className = 'confirm-icon warning';
            document.getElementById('confirm-title').textContent = 'åœç”¨å¸³è™Ÿ';
            document.getElementById('confirm-message').textContent = `ç¢ºå®šè¦åœç”¨ã€Œ${memberName}ã€çš„å¸³è™Ÿå—ï¼Ÿåœç”¨å¾Œè©²æœƒå“¡å°‡ç„¡æ³•ç™»å…¥ã€‚`;
            document.getElementById('confirm-btn').className = 'btn btn-warning';
            document.getElementById('confirm-btn').textContent = 'åœç”¨';
            document.getElementById('confirm-modal').classList.add('show');
        }

        function confirmActivate(memberId, memberName) {
            pendingAction = { type: 'activate', memberId, memberName };
            document.getElementById('confirm-icon').textContent = 'âœ…';
            document.getElementById('confirm-icon').className = 'confirm-icon';
            document.getElementById('confirm-icon').style.color = '#2d8a4e';
            document.getElementById('confirm-title').textContent = 'å•Ÿç”¨å¸³è™Ÿ';
            document.getElementById('confirm-message').textContent = `ç¢ºå®šè¦å•Ÿç”¨ã€Œ${memberName}ã€çš„å¸³è™Ÿå—ï¼Ÿ`;
            document.getElementById('confirm-btn').className = 'btn btn-primary';
            document.getElementById('confirm-btn').textContent = 'å•Ÿç”¨';
            document.getElementById('confirm-modal').classList.add('show');
        }

        function confirmDelete(memberId, memberName) {
            pendingAction = { type: 'delete', memberId, memberName };
            document.getElementById('confirm-icon').textContent = 'ğŸ—‘ï¸';
            document.getElementById('confirm-icon').className = 'confirm-icon danger';
            document.getElementById('confirm-title').textContent = 'åˆªé™¤å¸³è™Ÿ';
            document.getElementById('confirm-message').textContent = `ç¢ºå®šè¦åˆªé™¤ã€Œ${memberName}ã€çš„å¸³è™Ÿå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`;
            document.getElementById('confirm-btn').className = 'btn btn-danger';
            document.getElementById('confirm-btn').textContent = 'åˆªé™¤';
            document.getElementById('confirm-modal').classList.add('show');
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.remove('show');
            pendingAction = null;
        }

        async function executeAction() {
            if (!pendingAction) return;

            const { type, memberId, memberName } = pendingAction;

            try {
                switch (type) {
                    case 'suspend':
                        await AdminAPI.members.updateStatus(memberId, 'suspended');
                        showToast(`å·²åœç”¨ã€Œ${memberName}ã€çš„å¸³è™Ÿ`, 'success');
                        break;
                    case 'activate':
                        await AdminAPI.members.updateStatus(memberId, 'active');
                        showToast(`å·²å•Ÿç”¨ã€Œ${memberName}ã€çš„å¸³è™Ÿ`, 'success');
                        break;
                    case 'delete':
                        await AdminAPI.members.delete(memberId);
                        showToast(`å·²åˆªé™¤ã€Œ${memberName}ã€çš„å¸³è™Ÿ`, 'success');
                        break;
                }

                closeConfirmModal();
                loadMembers();
            } catch (error) {
                showToast(error.message || 'æ“ä½œå¤±æ•—', 'error');
            }
        }

        // é¡åº¦èª¿æ•´ç›¸é—œ
        let currentCreditMember = null;

        function openCreditModal(memberId, memberName, currentCredit) {
            currentCreditMember = { id: memberId, name: memberName, credit: currentCredit };
            document.getElementById('credit-member-name').textContent = `æœƒå“¡ï¼š${memberName}`;
            document.getElementById('current-credit').textContent = `$${currentCredit.toLocaleString()}`;
            document.getElementById('credit-amount').value = '';
            document.getElementById('credit-modal').classList.add('show');
        }

        function closeCreditModal() {
            document.getElementById('credit-modal').classList.remove('show');
            currentCreditMember = null;
        }

        async function adjustCredit(direction) {
            if (!currentCreditMember) return;
            const amount = parseInt(document.getElementById('credit-amount').value);
            if (!amount || amount <= 0) {
                showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡', 'error');
                return;
            }
            const adjustment = amount * direction;
            try {
                const result = await AdminAPI.members.updateCredit(currentCreditMember.id, { adjustment });
                showToast(`å·²${direction > 0 ? 'å¢åŠ ' : 'æ¸›å°‘'} $${amount} é¡åº¦`, 'success');
                currentCreditMember.credit = result.credit;
                document.getElementById('current-credit').textContent = `$${result.credit.toLocaleString()}`;
                loadMembers();
            } catch (error) {
                showToast(error.message || 'èª¿æ•´é¡åº¦å¤±æ•—', 'error');
            }
        }

        async function setCredit() {
            if (!currentCreditMember) return;
            const credit = parseInt(document.getElementById('credit-amount').value);
            if (isNaN(credit) || credit < 0) {
                showToast('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡', 'error');
                return;
            }
            try {
                const result = await AdminAPI.members.updateCredit(currentCreditMember.id, { credit });
                showToast(`å·²è¨­å®šé¡åº¦ç‚º $${credit}`, 'success');
                currentCreditMember.credit = result.credit;
                document.getElementById('current-credit').textContent = `$${result.credit.toLocaleString()}`;
                loadMembers();
            } catch (error) {
                showToast(error.message || 'è¨­å®šé¡åº¦å¤±æ•—', 'error');
            }
        }

        // ç‹€æ…‹ç¯©é¸
        document.querySelectorAll('.status-filter-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                document.querySelectorAll('.status-filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.status;
                renderMembers();
            });
        });

        // æœå°‹
        document.getElementById('search-input').addEventListener('input', debounce(loadMembers, 300));

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        document.addEventListener('DOMContentLoaded', loadMembers);
    </script>
</body>

</html>