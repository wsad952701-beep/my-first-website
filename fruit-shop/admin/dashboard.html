<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å„€è¡¨æ¿ | æœå¯¦æ¬é‹å·¥ å¾Œå°</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="/admin/css/admin.css">
    <style>
        .period-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .period-tab {
            padding: 10px 20px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            font-size: 0.9rem;
        }

        .period-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .period-tab.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-light);
        }

        .financial-summary {
            background: linear-gradient(135deg, rgba(45, 138, 78, 0.2) 0%, rgba(76, 175, 80, 0.1) 100%);
            border-radius: var(--radius-md);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .financial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .financial-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .financial-period {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            padding: 6px 12px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .financial-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .financial-item {
            text-align: center;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-sm);
        }

        .financial-item .label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 8px;
        }

        .financial-item .value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .financial-item .value.revenue {
            color: var(--accent-orange);
        }

        .financial-item .value.orders {
            color: var(--accent-blue);
        }

        .financial-item .value.pending {
            color: var(--accent-gold);
        }

        .financial-item .value.completed {
            color: var(--primary-light);
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .quick-stat {
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .quick-stat .icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .quick-stat .icon.blue {
            background: rgba(52, 152, 219, 0.2);
            color: var(--accent-blue);
        }

        .quick-stat .icon.green {
            background: rgba(45, 138, 78, 0.2);
            color: var(--primary-light);
        }

        .quick-stat .info .label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .quick-stat .info .value {
            font-size: 1.1rem;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <span>ğŸ‡</span>
                    <span>æœå¯¦æ¬é‹å·¥</span>
                </div>
                <div class="sidebar-subtitle">å¾Œå°ç®¡ç†ç³»çµ±</div>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">ä¸»è¦åŠŸèƒ½</div>
                    <a href="/admin/dashboard.html" class="nav-item active">
                        <i class="fas fa-chart-line"></i>
                        <span>å„€è¡¨æ¿</span>
                    </a>
                    <a href="/admin/orders.html" class="nav-item">
                        <i class="fas fa-box"></i>
                        <span>è¨‚å–®ç®¡ç†</span>
                        <span class="badge" id="pending-badge" style="display: none;">0</span>
                    </a>
                    <a href="/admin/products.html" class="nav-item">
                        <i class="fas fa-apple-alt"></i>
                        <span>å•†å“ç®¡ç†</span>
                    </a>
                    <a href="/admin/members.html" class="nav-item">
                        <i class="fas fa-users"></i>
                        <span>æœƒå“¡ç®¡ç†</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">ç³»çµ±è¨­å®š</div>
                    <a href="/admin/settings.html" class="nav-item">
                        <i class="fas fa-cog"></i>
                        <span>ç¶²ç«™è¨­å®š</span>
                    </a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">å¿«æ·æ“ä½œ</div>
                    <a href="/frontend/" class="nav-item" target="_blank">
                        <i class="fas fa-external-link-alt"></i>
                        <span>å‰å¾€å‰å°</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="top-bar">
                <h1 class="page-title">ğŸ“Š å„€è¡¨æ¿</h1>
                <div class="top-bar-actions">
                    <div class="admin-profile">
                        <div class="admin-avatar">ğŸ‘¤</div>
                        <div class="admin-info">
                            <span class="admin-name" id="admin-name">ç®¡ç†å“¡</span>
                            <span class="admin-role">ç³»çµ±ç®¡ç†å“¡</span>
                        </div>
                    </div>
                    <button class="logout-btn" title="ç™»å‡º">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <!-- Period Tabs -->
            <div class="period-tabs">
                <button class="period-tab active" data-period="today">ğŸ“… ä»Šå¤©</button>
                <button class="period-tab" data-period="yesterday">ğŸ“… æ˜¨å¤©</button>
                <button class="period-tab" data-period="this-week">ğŸ“… æœ¬é€±</button>
                <button class="period-tab" data-period="this-month">ğŸ“… æœ¬æœˆ</button>
                <button class="period-tab" data-period="last-month">ğŸ“… ä¸Šæœˆ</button>
                <button class="period-tab" data-period="all">ğŸ“… å…¨éƒ¨</button>
            </div>

            <!-- Financial Summary -->
            <div class="financial-summary">
                <div class="financial-header">
                    <div class="financial-title">ğŸ’° è²¡å‹™çµ±è¨ˆæ¦‚è¦½</div>
                    <div class="financial-period" id="period-label">ä»Šå¤©</div>
                </div>
                <div class="financial-grid" id="financial-grid">
                    <div class="financial-item">
                        <div class="label">ğŸ“Š ç¸½ç‡Ÿæ”¶</div>
                        <div class="value revenue" id="period-revenue">$0</div>
                    </div>
                    <div class="financial-item">
                        <div class="label">ğŸ“¦ è¨‚å–®æ•¸é‡</div>
                        <div class="value orders" id="period-orders">0</div>
                    </div>
                    <div class="financial-item">
                        <div class="label">â³ å¾…è™•ç†è¨‚å–®</div>
                        <div class="value pending" id="period-pending">0</div>
                    </div>
                    <div class="financial-item">
                        <div class="label">âœ… å·²å®Œæˆè¨‚å–®</div>
                        <div class="value completed" id="period-completed">0</div>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid" id="stats-grid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>

            <!-- Dashboard Grid -->
            <div class="dashboard-grid">
                <!-- Recent Orders -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-clock"></i> æœ€è¿‘è¨‚å–®</h2>
                        <a href="/admin/orders.html" class="action-btn outline">æŸ¥çœ‹å…¨éƒ¨</a>
                    </div>
                    <div class="card-body" id="recent-orders">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats & Top Products -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-fire"></i> ç†±éŠ·å•†å“</h2>
                    </div>
                    <div class="card-body" id="top-products">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="/admin/js/api.js"></script>
    <script>
        // æª¢æŸ¥æ¬Šé™
        if (!checkAdminAuth()) {
            // Will redirect
        }

        let allOrders = [];
        let dashboardData = null;
        let currentPeriod = 'today';

        const periodLabels = {
            'today': 'ä»Šå¤©',
            'yesterday': 'æ˜¨å¤©',
            'this-week': 'æœ¬é€±',
            'this-month': 'æœ¬æœˆ',
            'last-month': 'ä¸Šæœˆ',
            'all': 'å…¨éƒ¨æ™‚é–“'
        };

        // æ—¥æœŸç¯„åœè¨ˆç®—
        function getDateRange(filter) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

            switch (filter) {
                case 'today':
                    return { start: today, end: new Date(today.getTime() + 24 * 60 * 60 * 1000) };
                case 'yesterday':
                    const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                    return { start: yesterday, end: today };
                case 'this-week':
                    const weekStart = new Date(today);
                    weekStart.setDate(weekStart.getDate() - weekStart.getDay());
                    return { start: weekStart, end: new Date(today.getTime() + 24 * 60 * 60 * 1000) };
                case 'this-month':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    return { start: monthStart, end: new Date(today.getTime() + 24 * 60 * 60 * 1000) };
                case 'last-month':
                    const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 1);
                    return { start: lastMonthStart, end: lastMonthEnd };
                default:
                    return null;
            }
        }

        function updatePeriodStats(period) {
            currentPeriod = period;
            const dateRange = getDateRange(period);

            document.getElementById('period-label').textContent = periodLabels[period];

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.period-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === period);
            });

            // éæ¿¾è¨‚å–®
            let filteredOrders = allOrders;
            if (dateRange) {
                filteredOrders = allOrders.filter(order => {
                    const orderDate = new Date(order.created_at);
                    return orderDate >= dateRange.start && orderDate < dateRange.end;
                });
            }

            // è¨ˆç®—çµ±è¨ˆ
            const revenue = filteredOrders.reduce((sum, o) => sum + (o.total_amount || 0), 0);
            const orderCount = filteredOrders.length;
            const pendingCount = filteredOrders.filter(o => o.status === 'pending').length;
            const completedCount = filteredOrders.filter(o => o.status === 'completed').length;

            // æ›´æ–°é¡¯ç¤º
            document.getElementById('period-revenue').textContent = formatPrice(revenue);
            document.getElementById('period-orders').textContent = orderCount;
            document.getElementById('period-pending').textContent = pendingCount;
            document.getElementById('period-completed').textContent = completedCount;
        }

        // è¼‰å…¥å„€è¡¨æ¿æ•¸æ“š
        async function loadDashboard() {
            try {
                const data = await AdminAPI.dashboard.get();
                dashboardData = data;

                // è¼‰å…¥æ‰€æœ‰è¨‚å–®ç”¨æ–¼çµ±è¨ˆ
                try {
                    const ordersData = await AdminAPI.orders.getAll({});
                    allOrders = ordersData.orders || [];
                } catch (e) {
                    allOrders = data.recentOrders || [];
                }

                // åˆå§‹åŒ–æ™‚é–“å€é–“çµ±è¨ˆ
                updatePeriodStats('today');

                // æ›´æ–°çµ±è¨ˆå¡ç‰‡
                document.getElementById('stats-grid').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-icon green"><i class="fas fa-dollar-sign"></i></div>
                        <div class="stat-info">
                            <h3>ç´¯è¨ˆç¸½ç‡Ÿæ”¶</h3>
                            <div class="stat-value">${formatPrice(data.total.revenue || 0)}</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon orange"><i class="fas fa-shopping-bag"></i></div>
                        <div class="stat-info">
                            <h3>ç¸½è¨‚å–®æ•¸</h3>
                            <div class="stat-value">${data.total.orders || 0}</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple"><i class="fas fa-box"></i></div>
                        <div class="stat-info">
                            <h3>å•†å“æ•¸é‡</h3>
                            <div class="stat-value">${data.total.products || 0}</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon blue"><i class="fas fa-users"></i></div>
                        <div class="stat-info">
                            <h3>ç¸½æœƒå“¡æ•¸</h3>
                            <div class="stat-value">${data.total.members || 0}</div>
                        </div>
                    </div>
                `;

                // æ›´æ–°å¾…è™•ç†è¨‚å–®å¾½ç« 
                const pendingBadge = document.getElementById('pending-badge');
                if (data.total.pending_orders > 0) {
                    pendingBadge.textContent = data.total.pending_orders;
                    pendingBadge.style.display = 'block';
                }

                // æ›´æ–°æœ€è¿‘è¨‚å–®
                if (data.recentOrders.length === 0) {
                    document.getElementById('recent-orders').innerHTML = '<p style="color: rgba(255,255,255,0.6); text-align: center;">æš«ç„¡è¨‚å–®</p>';
                } else {
                    document.getElementById('recent-orders').innerHTML = data.recentOrders.slice(0, 5).map(order => `
                        <div class="order-mini">
                            <div class="order-mini-info">
                                <h4>${order.order_number}</h4>
                                <p>${order.customer_name || 'è¨ªå®¢'} â€¢ ${formatDate(order.created_at)}</p>
                            </div>
                            <div>
                                <span class="status-badge status-${order.status}">${getStatusText(order.status)}</span>
                            </div>
                            <div class="order-mini-amount">${formatPrice(order.total_amount)}</div>
                        </div>
                    `).join('');
                }

                // æ›´æ–°ç†±éŠ·å•†å“
                if (data.topProducts.length === 0) {
                    document.getElementById('top-products').innerHTML = '<p style="color: rgba(255,255,255,0.6); text-align: center;">æš«ç„¡æ•¸æ“š</p>';
                } else {
                    document.getElementById('top-products').innerHTML = data.topProducts.map((product, index) => `
                        <div class="order-mini">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="width: 30px; height: 30px; border-radius: 50%; background: ${index < 3 ? 'var(--accent-orange)' : 'rgba(255,255,255,0.1)'}; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem;">
                                    ${index + 1}
                                </div>
                                <div>
                                    <h4 style="font-size: 0.95rem;">${product.name}</h4>
                                    <p style="font-size: 0.85rem; color: rgba(255,255,255,0.6);">éŠ·å”® ${product.total_sold} ä»¶</p>
                                </div>
                            </div>
                            <div class="order-mini-amount">${formatPrice(product.price)}</div>
                        </div>
                    `).join('');
                }

                // æ›´æ–°ç®¡ç†å“¡åç¨±
                const user = TokenManager.getUser();
                if (user) {
                    document.getElementById('admin-name').textContent = user.name;
                }

            } catch (error) {
                console.error('è¼‰å…¥å„€è¡¨æ¿å¤±æ•—:', error);
                showToast('è¼‰å…¥æ•¸æ“šå¤±æ•—', 'error');
            }
        }

        // æ™‚é–“å€é–“åˆ‡æ›äº‹ä»¶
        document.querySelectorAll('.period-tab').forEach(btn => {
            btn.addEventListener('click', () => {
                updatePeriodStats(btn.dataset.period);
            });
        });

        document.addEventListener('DOMContentLoaded', loadDashboard);
    </script>
</body>

</html>